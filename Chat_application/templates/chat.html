{% extends "base.html" %}

{% block title %}{{ get_text('chat_with') }} - {{ get_text('app_title') }}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        height: 90vh;
        background: #fff;
        border: 2px solid #2c2c2c;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 8px 8px 0px #2c2c2c;
    }

    .sidebar {
        width: 300px;
        background: #f9f9f9;
        border-right: 2px solid #2c2c2c;
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 20px;
        background: #2c2c2c;
        color: #fff;
        text-align: center;
    }

    .sidebar-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }

    .current-user {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 5px;
    }

    .user-list {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
    }

    .user-item {
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .user-item.selected {
        background-color: black;
    }

    .user-item:hover {
        background-color: var(--hover-bg);
    }

    .user-info {
        flex: 1;
    }

    .user-name {
        font-size: 1rem;
        margin-bottom: 3px;
    }

    .user-status {
        font-size: 0.8rem;
        opacity: 0.7;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-online {
        background: #4caf50;
        animation: pulse 2s infinite;
    }

    .status-offline {
        background: #999;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .unread-badge {
        background: #ff4444;
        color: #fff;
        border-radius: 50%;
        padding: 4px 8px;
        font-size: 0.7rem;
        min-width: 20px;
        text-align: center;
        margin-left: 10px;
        animation: bounce 0.5s ease-in-out;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-5px); }
        60% { transform: translateY(-3px); }
    }

    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 20px;
        background: #2c2c2c;
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-with {
        font-size: 1.3rem;
        font-weight: bold;
    }

    .logout-btn {
        background: #fff;
        color: #2c2c2c;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-family: inherit;
        text-decoration: none;
        font-size: 0.9rem;
    }

    .logout-btn:hover {
        background: #f0f0f0;
    }

    .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: linear-gradient(135deg, #f9f9f9 0%, #f0f0f0 100%);
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-end;
    }

    .message.sent {
        justify-content: flex-end;
    }

    .message.received {
        justify-content: flex-start;
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 20px;
        position: relative;
        font-size: 1rem;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .message.sent .message-bubble {
        background: #2c2c2c;
        color: #fff;
        border-bottom-right-radius: 5px;
        margin-left: 20px;
    }

    .message.received .message-bubble {
        background: #fff;
        color: #2c2c2c;
        border: 2px solid #2c2c2c;
        border-bottom-left-radius: 5px;
        margin-right: 20px;
    }

    .message-info {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 5px;
    }

    .message.sent .message-info {
        text-align: right;
        color: #fff;
    }

    .message.received .message-info {
        text-align: left;
        color: #666;
    }

    .delete-btn {
        background: none;
        border: none;
        color: #ff4444;
        cursor: pointer;
        font-size: 0.8rem;
        margin-left: 10px;
        opacity: 0.7;
        transition: opacity 0.3s ease;
    }

    .delete-btn:hover {
        opacity: 1;
    }

    .message-input-area {
        padding: 20px;
        background: #f9f9f9;
        border-top: 2px solid #2c2c2c;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .input-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .message-input {
        flex: 1;
        padding: 15px;
        border: 2px solid #2c2c2c;
        border-radius: 25px;
        font-family: 'Courier New', 'Noto Sans Tamil', monospace;
        font-size: 1rem;
        outline: none;
        background: #fff;
        min-height: 50px;
        resize: none;
    }

    .message-input:focus {
        box-shadow: 3px 3px 0px #2c2c2c;
    }

    .emoji-sticker-controls {
        display: flex;
        gap: 5px;
    }

    .emoji-btn, .sticker-btn {
        background: #2c2c2c;
        color: #fff;
        border: none;
        padding: 12px 15px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .emoji-btn:hover, .sticker-btn:hover {
        background: #1a1a1a;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px #666;
    }

    .send-btn {
        background: #2c2c2c;
        color: #fff;
        border: none;
        padding: 15px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-family: inherit;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .send-btn:hover {
        background: #1a1a1a;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px #666;
    }

    .emoji-picker {
        position: absolute;
        bottom: 80px;
        left: 20px;
        background: #fff;
        border: 2px solid #2c2c2c;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 8px 8px 0px #2c2c2c;
        display: none;
        max-width: 300px;
        z-index: 1000;
    }

    .emoji-picker.show {
        display: block;
    }

    .emoji-categories {
        display: flex;
        gap: 5px;
        margin-bottom: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .emoji-category {
        background: #f9f9f9;
        border: 2px solid #2c2c2c;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .emoji-category:hover, .emoji-category.active {
        background: #2c2c2c;
        color: #fff;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
        max-height: 200px;
        overflow-y: auto;
    }

    .emoji-item {
        font-size: 1.5rem;
        padding: 8px;
        cursor: pointer;
        text-align: center;
        border-radius: 5px;
        transition: all 0.3s ease;
    }

    .emoji-item:hover {
        background: #f0f0f0;
        transform: scale(1.2);
    }

    .sticker-picker {
        position: absolute;
        bottom: 80px;
        left: 80px;
        background: #fff;
        border: 2px solid #2c2c2c;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 8px 8px 0px #2c2c2c;
        display: none;
        max-width: 350px;
        z-index: 1000;
    }

    .sticker-picker.show {
        display: block;
    }

    .sticker-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        max-height: 250px;
        overflow-y: auto;
    }

    .sticker-item {
        background: #f9f9f9;
        border: 2px solid #2c2c2c;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        text-align: center;
        font-size: 2rem;
        transition: all 0.3s ease;
    }

    .sticker-item:hover {
        background: #2c2c2c;
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 3px 3px 0px #666;
    }

    .welcome-message {
        text-align: center;
        padding: 50px 20px;
        color: #666;
        font-size: 1.2rem;
    }

    .no-messages {
        text-align: center;
        padding: 30px 20px;
        color: #999;
        font-style: italic;
    }

    .notification-controls {
        padding: 15px;
        background: #f0f0f0;
        border-top: 2px solid #2c2c2c;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .notification-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        color: #2c2c2c;
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 25px;
        background: #ccc;
        border-radius: 25px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .toggle-switch.active {
        background: #4caf50;
    }

    .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 21px;
        height: 21px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch.active .toggle-slider {
        transform: translateX(25px);
    }

    .typing-indicator {
        padding: 10px 20px;
        background: #f9f9f9;
        border-top: 1px solid #ddd;
        font-style: italic;
        color: #666;
        display: none;
        animation: fadeInOut 2s infinite;
    }

    @keyframes fadeInOut {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }

    .notification-popup {
        position: fixed;
        top: 80px;
        right: 20px;
        background: #2c2c2c;
        color: #fff;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
        border: 2px solid #555;
        animation: slideInNotification 0.3s ease-out;
    }

    .notification-popup.show {
        transform: translateX(0);
    }

    .notification-header {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 1rem;
    }

    .notification-body {
        font-size: 0.9rem;
        opacity: 0.9;
        line-height: 1.4;
    }

    @keyframes slideInNotification {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .activity-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        background: #4caf50;
        border-radius: 50%;
        margin-left: 5px;
        animation: pulse 2s infinite;
    }

    .activity-indicator.typing {
        background: #ff9800;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }

    .typing-dots {
        display: inline-block;
        animation: typingDots 1.5s infinite;
    }

    @keyframes typingDots {
        0%, 60%, 100% { content: ''; }
        20% { content: '.'; }
        40% { content: '..'; }
        80% { content: '...'; }
    }

    @media (max-width: 768px) {
        .chat-container {
            flex-direction: column;
            height: auto;
        }
        
        .sidebar {
            width: 100%;
            max-height: 300px;
        }
        
        .message-bubble {
            max-width: 85%;
        }
        
        .input-row {
            flex-direction: column;
            gap: 15px;
        }
        
        .emoji-sticker-controls {
            justify-content: center;
        }
        
        .send-btn {
            align-self: stretch;
            margin-top: 10px;
        }

        .emoji-picker, .sticker-picker {
            left: 10px;
            right: 10px;
            max-width: none;
        }

        .emoji-grid {
            grid-template-columns: repeat(6, 1fr);
        }

        .sticker-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Language Switcher -->
<div class="language-switcher">
    <h4>{{ get_text('language') }}</h4>
    <div class="language-buttons">
        <a href="{{ url_for('set_language', language='en') }}" 
           class="lang-btn {{ 'active' if current_language == 'en' else '' }}">
            üá∫üá∏ EN
        </a>
        <a href="{{ url_for('set_language', language='ta') }}" 
           class="lang-btn {{ 'active' if current_language == 'ta' else '' }}">
            üáÆüá≥ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç
        </a>
    </div>
</div>

<div class="header">
    <h1>{{ get_text('app_title') }}</h1>
    <p class="subtitle">{{ get_text('welcome') }}, {{ current_user }}!</p>
</div>

<div class="chat-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>{{ get_text('users') }}</h3>
            <div class="current-user">{{ get_text('welcome') }}, {{ current_user }}!</div>
        </div>
        <div class="user-list">
            {% for user in users %}
            <div class="user-item" data-email="{{ user.email }}" data-name="{{ user.display_name }}">
                <div class="user-info">
                    <div class="user-name">{{ user.display_name }}</div>
                    <div class="user-status">
                        <span class="status-indicator {{ 'status-online' if user.is_online else 'status-offline' }}"></span>
                        {% if user.is_online %}
                            {{ get_text('online') }}
                        {% else %}
                            {{ get_text('last_seen') }} {{ user.last_seen[:16] if user.last_seen else '' }}
                        {% endif %}
                    </div>
                </div>
                {% if user.unread_count > 0 %}
                <div class="unread-badge">{{ user.unread_count }}</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <div class="notification-controls">
            <div class="notification-toggle">
                <span>{{ get_text('notifications') }}</span>
                <div class="toggle-switch" id="notification-toggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="notification-toggle">
                <span>{{ get_text('sound_notifications') }}</span>
                <div class="toggle-switch" id="sound-toggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-with" id="chat-with">{% if current_language == 'ta' %}‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï ‡Æí‡Æ∞‡ØÅ ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç{% else %}Select a user to start chatting{% endif %}</div>
            <a href="{{ url_for('logout') }}" class="logout-btn">{{ get_text('logout') }}</a>
        </div>

        <div class="messages-container" id="messages">
            <div class="welcome-message">
                <h3>üéâ {{ get_text('welcome') }}!</h3>
                <p>{% if current_language == 'ta' %}‡Æá‡Æü‡Æ§‡ØÅ ‡Æ™‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æø‡ÆØ‡Æø‡Æ≤‡Øç ‡Æá‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ ‡Æí‡Æ∞‡ØÅ ‡Æ™‡ÆØ‡Æ©‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.{% else %}Select a user from the left sidebar to start chatting.{% endif %}</p>
            </div>
        </div>
        
        <div class="typing-indicator" id="typing-indicator">
            <span id="typing-user"></span> {{ get_text('typing') }}
        </div>

        <div class="message-input-area" id="input-area" style="display: none;">
            <div class="input-row">
                <textarea id="message-input" class="message-input" placeholder="{% if current_language == 'ta' %}‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡ÆÜ‡Æô‡Øç‡Æï‡Æø‡Æ≤‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà ‡Æ§‡Æü‡Øç‡Æü‡Æö‡Øç‡Æö‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç...{% else %}Type your message in Tamil or English...{% endif %}" maxlength="500" rows="1"></textarea>
                <div class="emoji-sticker-controls">
                    <button id="emoji-btn" class="emoji-btn" title="{% if current_language == 'ta' %}‡Æµ‡ØÜ‡Æ≥‡Æø‡Æ™‡Øç‡Æ™‡Ææ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç{% else %}Emojis{% endif %}">üòä</button>
                    <button id="sticker-btn" class="sticker-btn" title="{% if current_language == 'ta' %}‡Æ∏‡Øç‡Æü‡Æø‡Æï‡Øç‡Æï‡Æ∞‡Øç‡Æï‡Æ≥‡Øç{% else %}Stickers{% endif %}">üé™</button>
                </div>
                <button id="send-btn" class="send-btn">{{ get_text('send') }}</button>
            </div>
            
            <!-- Emoji Picker -->
            <div class="emoji-picker" id="emoji-picker">
                <div class="emoji-categories">
                    <button class="emoji-category active" data-category="smileys">üòä</button>
                    <button class="emoji-category" data-category="people">üëã</button>
                    <button class="emoji-category" data-category="nature">üå∏</button>
                    <button class="emoji-category" data-category="food">üçï</button>
                    <button class="emoji-category" data-category="activities">‚öΩ</button>
                    <button class="emoji-category" data-category="travel">üöó</button>
                    <button class="emoji-category" data-category="objects">üì±</button>
                    <button class="emoji-category" data-category="symbols">‚ù§Ô∏è</button>
                </div>
                <div class="emoji-grid" id="emoji-grid"></div>
            </div>

            <!-- Sticker Picker -->
            <div class="sticker-picker" id="sticker-picker">
                <div class="sticker-grid" id="sticker-grid"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentReceiver = null;
    let messagePollingInterval = null;
    let typingInterval = null;
    let activityInterval = null;
    let isTyping = false;
    let typingTimeout = null;
    const currentUserEmail = '{{ session.user_email }}';

    // Notification settings
    let notificationPreferences = {
        desktop_notifications: true,
        sound_notifications: true,
        typing_notifications: true
    };

    // DOM elements
    const userItems = document.querySelectorAll('.user-item');
    const messagesContainer = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const chatWith = document.getElementById('chat-with');
    const inputArea = document.getElementById('input-area');
    const emojiBtn = document.getElementById('emoji-btn');
    const stickerBtn = document.getElementById('sticker-btn');
    const emojiPicker = document.getElementById('emoji-picker');
    const stickerPicker = document.getElementById('sticker-picker');
    const emojiGrid = document.getElementById('emoji-grid');
    const stickerGrid = document.getElementById('sticker-grid');
    const notificationToggle = document.getElementById('notification-toggle');
    const soundToggle = document.getElementById('sound-toggle');
    const typingIndicator = document.getElementById('typing-indicator');

    // Emoji data
    const emojiData = {
        smileys: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•∏','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï'],
        people: ['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','üëä','‚úä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ','üíã','üë∂','üßí','üë¶','üëß','üßë','üë±','üë®','üßî','üë®‚Äçü¶∞','üë®‚Äçü¶±','üë®‚Äçü¶≥','üë®‚Äçü¶≤','üë©','üë©‚Äçü¶∞','üßë‚Äçü¶∞','üë©‚Äçü¶±','üßë‚Äçü¶±','üë©‚Äçü¶≥','üßë‚Äçü¶≥','üë©‚Äçü¶≤','üßë‚Äçü¶≤','üë±‚Äç‚ôÄÔ∏è','üë±‚Äç‚ôÇÔ∏è','üßì','üë¥','üëµ','üôç','üôç‚Äç‚ôÇÔ∏è','üôç‚Äç‚ôÄÔ∏è','üôé','üôé‚Äç‚ôÇÔ∏è','üôé‚Äç‚ôÄÔ∏è','üôÖ','üôÖ‚Äç‚ôÇÔ∏è','üôÖ‚Äç‚ôÄÔ∏è','üôÜ','üôÜ‚Äç‚ôÇÔ∏è','üôÜ‚Äç‚ôÄÔ∏è','üíÅ','üíÅ‚Äç‚ôÇÔ∏è','üíÅ‚Äç‚ôÄÔ∏è','üôã','üôã‚Äç‚ôÇÔ∏è','üôã‚Äç‚ôÄÔ∏è','üßè','üßè‚Äç‚ôÇÔ∏è','üßè‚Äç‚ôÄÔ∏è','üôá','üôá‚Äç‚ôÇÔ∏è','üôá‚Äç‚ôÄÔ∏è','ü§¶','ü§¶‚Äç‚ôÇÔ∏è','ü§¶‚Äç‚ôÄÔ∏è','ü§∑','ü§∑‚Äç‚ôÇÔ∏è','ü§∑‚Äç‚ôÄÔ∏è'],
        nature: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üêí','üêî','üêß','üê¶','üê§','üê£','üê•','ü¶Ü','ü¶¢','ü¶Ö','ü¶â','ü¶§','ü™∂','ü¶©','ü¶ö','ü¶ú','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','ü¶ô','üêê','ü¶å','üêï','üê©','ü¶Æ','üêï‚Äçü¶∫','üêà','üêà‚Äç‚¨õ','üêì','ü¶É','ü¶ö','ü¶ú','ü¶¢','ü¶©','üïäÔ∏è','üêá','ü¶ù','ü¶®','ü¶°','ü¶¶','ü¶•','üêÅ','üêÄ','üêøÔ∏è','ü¶î'],
        food: ['üçè','üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂Ô∏è','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü´ì','ü•™','ü•ô','üßÜ','üåÆ','üåØ','ü´î','ü•ó','ü•ò','ü´ï','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•†','ü•Æ','üç¢','üç°','üçß','üç®','üç¶','ü•ß','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ'],
        activities: ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèë','üèí','ü•ç','üèè','ü™É','ü•Ö','‚õ≥','ü™Å','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõ∑','‚õ∏Ô∏è','ü•å','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','üèãÔ∏è‚Äç‚ôÇÔ∏è','üèãÔ∏è‚Äç‚ôÄÔ∏è','ü§º','ü§º‚Äç‚ôÇÔ∏è','ü§º‚Äç‚ôÄÔ∏è','ü§∏','ü§∏‚Äç‚ôÇÔ∏è','ü§∏‚Äç‚ôÄÔ∏è','‚õπÔ∏è','‚õπÔ∏è‚Äç‚ôÇÔ∏è','‚õπÔ∏è‚Äç‚ôÄÔ∏è','ü§∫','ü§æ','ü§æ‚Äç‚ôÇÔ∏è','ü§æ‚Äç‚ôÄÔ∏è','üèåÔ∏è','üèåÔ∏è‚Äç‚ôÇÔ∏è','üèåÔ∏è‚Äç‚ôÄÔ∏è','üèá','üßò','üßò‚Äç‚ôÇÔ∏è','üßò‚Äç‚ôÄÔ∏è','üèÑ','üèÑ‚Äç‚ôÇÔ∏è','üèÑ‚Äç‚ôÄÔ∏è','üèä','üèä‚Äç‚ôÇÔ∏è','üèä‚Äç‚ôÄÔ∏è','ü§Ω','ü§Ω‚Äç‚ôÇÔ∏è','ü§Ω‚Äç‚ôÄÔ∏è','üö£','üö£‚Äç‚ôÇÔ∏è','üö£‚Äç‚ôÄÔ∏è','üßó','üßó‚Äç‚ôÇÔ∏è','üßó‚Äç‚ôÄÔ∏è','üöµ','üöµ‚Äç‚ôÇÔ∏è','üöµ‚Äç‚ôÄÔ∏è','üö¥','üö¥‚Äç‚ôÇÔ∏è','üö¥‚Äç‚ôÄÔ∏è','üèÜ','ü•á','ü•à','ü•â','üèÖ','üéñÔ∏è','üèµÔ∏è','üéóÔ∏è','üé´','üéüÔ∏è','üé™','ü§π','ü§π‚Äç‚ôÇÔ∏è','ü§π‚Äç‚ôÄÔ∏è','üé≠','ü©∞','üé®','üé¨','üé§','üéß','üéº','üéµ','üé∂','ü•Å','ü™ò','üéπ','üé∑','üé∫','üé∏','ü™ï','üéª'],
        travel: ['üöó','üöï','üöô','üöå','üöé','üèéÔ∏è','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','ü¶Ø','ü¶Ω','ü¶º','üõ¥','üö≤','üõµ','üèçÔ∏è','üõ∫','üö®','üöî','üöç','üöò','üöñ','üö°','üö†','üöü','üöÉ','üöã','üöû','üöù','üöÑ','üöÖ','üöà','üöÇ','üöÜ','üöá','üöä','üöâ','‚úàÔ∏è','üõ´','üõ¨','üõ©Ô∏è','üí∫','üõ∞Ô∏è','üöÄ','üõ∏','üöÅ','üõ∂','‚õµ','üö§','üõ•Ô∏è','üõ≥Ô∏è','‚õ¥Ô∏è','üö¢','‚öì','‚õΩ','üöß','üö¶','üö•','üó∫Ô∏è','üóø','üóΩ','üóº','üè∞','üèØ','üèüÔ∏è','üé°','üé¢','üé†','‚õ±Ô∏è','üèñÔ∏è','üèùÔ∏è','üèúÔ∏è','üåã','‚õ∞Ô∏è','üèîÔ∏è','üóª','üèïÔ∏è','‚õ∫','üõñ','üè†','üè°','üèòÔ∏è','üèöÔ∏è','üèóÔ∏è','üè≠','üè¢','üè¨','üè£','üè§','üè•','üè¶','üè®','üè™','üè´','üè©','üíí','üèõÔ∏è','‚õ™','üïå','üõï','üïç','üïäÔ∏è','üèûÔ∏è','üéå','üè¥','üè≥Ô∏è'],
        objects: ['‚åö','üì±','üì≤','üíª','‚å®Ô∏è','üñ•Ô∏è','üñ®Ô∏è','üñ±Ô∏è','üñ≤Ô∏è','üïπÔ∏è','üóúÔ∏è','üíΩ','üíæ','üíø','üìÄ','üìº','üì∑','üì∏','üìπ','üé•','üìΩÔ∏è','üéûÔ∏è','üìû','‚òéÔ∏è','üìü','üì†','üì∫','üìª','üéôÔ∏è','üéöÔ∏è','üéõÔ∏è','üß≠','‚è±Ô∏è','‚è≤Ô∏è','‚è∞','üï∞Ô∏è','‚åõ','‚è≥','üì°','üîã','üîå','üí°','üî¶','üïØÔ∏è','ü™î','üßØ','üõ¢Ô∏è','üí∏','üíµ','üí¥','üí∂','üí∑','ü™ô','üí∞','üí≥','üíé','‚öñÔ∏è','ü™ú','üß∞','üîß','üî®','‚öíÔ∏è','üõ†Ô∏è','‚õèÔ∏è','üî©','‚öôÔ∏è','üß±','‚õìÔ∏è','üß≤','üî´','üí£','üß®','ü™ì','üî™','üó°Ô∏è','‚öîÔ∏è','üõ°Ô∏è','üö¨','‚ö∞Ô∏è','ü™¶','‚ö±Ô∏è','üè∫','üîÆ','üìø','üßø','üíà','‚öóÔ∏è','üî≠','üî¨','üï≥Ô∏è','ü©π','ü©∫','üíä','üíâ','ü©∏','üß¨','ü¶†','üß´','üß™','üå°Ô∏è','üßπ','ü™†','üß¥','üßΩ','ü™£','üßº','ü™•','ü™í','üßæ','üßª','ü™ë','üöΩ','ü™§','ü™û','ü™ü'],
        symbols: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâÔ∏è','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è','‚ò¶Ô∏è','üõê','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå','‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','üÜî','‚öõÔ∏è','üâë','‚ò¢Ô∏è','‚ò£Ô∏è','üì¥','üì≥','üà∂','üàö','üà∏','üà∫','üà∑Ô∏è','‚ú¥Ô∏è','üÜö','üíÆ','üâê','„äôÔ∏è','„äóÔ∏è','üà¥','üàµ','üàπ','üà≤','üÖ∞Ô∏è','üÖ±Ô∏è','üÜé','üÜë','üÖæÔ∏è','üÜò','‚ùå','‚≠ï','üõë','‚õî','üìõ','üö´','üíØ','üí¢','‚ô®Ô∏è','üö∑','üöØ','üö≥','üö±','üîû','üìµ','üö≠','‚ùó','‚ùï','‚ùì','‚ùî','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','„ÄΩÔ∏è','‚ö†Ô∏è','üö∏','üî±','‚öúÔ∏è','üî∞','‚ôªÔ∏è','‚úÖ','üàØ','üíπ','‚ùáÔ∏è','‚ú≥Ô∏è','‚ùé','üåê','üí†','‚ìÇÔ∏è','üåÄ','üí§','üèß','üöæ','‚ôø','üÖøÔ∏è','üõó','üà≥','üàÇÔ∏è','üõÇ','üõÉ','üõÑ','üõÖ','üöπ','üö∫','üöº','‚ößÔ∏è','üöª','üöÆ','üé¶','üì∂','üàÅ','üî£','‚ÑπÔ∏è','üî§','üî°','üî†','üÜñ','üÜó','üÜô','üÜí','üÜï','üÜì','0Ô∏è‚É£','1Ô∏è‚É£','2Ô∏è‚É£','3Ô∏è‚É£','4Ô∏è‚É£','5Ô∏è‚É£','6Ô∏è‚É£','7Ô∏è‚É£','8Ô∏è‚É£','9Ô∏è‚É£','üîü','üî¢','#Ô∏è‚É£','*Ô∏è‚É£','‚èèÔ∏è','‚ñ∂Ô∏è','‚è∏Ô∏è','‚èØÔ∏è','‚èπÔ∏è','‚è∫Ô∏è','‚è≠Ô∏è','‚èÆÔ∏è','‚è©','‚è™','‚è´','‚è¨','‚óÄÔ∏è','üîº','üîΩ','‚û°Ô∏è','‚¨ÖÔ∏è','‚¨ÜÔ∏è','‚¨áÔ∏è','‚ÜóÔ∏è','‚ÜòÔ∏è','‚ÜôÔ∏è','‚ÜñÔ∏è','‚ÜïÔ∏è','‚ÜîÔ∏è','‚Ü™Ô∏è','‚Ü©Ô∏è','‚§¥Ô∏è','‚§µÔ∏è','üîÄ','üîÅ','üîÇ','üîÑ','üîÉ','üéµ','üé∂','‚ûï','‚ûñ','‚ûó','‚úñÔ∏è','üü∞','‚ôæÔ∏è','üí≤','üí±','‚Ñ¢Ô∏è','¬©Ô∏è','¬ÆÔ∏è','„Ä∞Ô∏è','‚û∞','‚ûø','üîö','üîô','üîõ','üîù','üîú','‚úîÔ∏è','‚òëÔ∏è','üîò','üî¥','üü†','üü°','üü¢','üîµ','üü£','‚ö´','‚ö™','üü§','üî∫','üîª','üî∏','üîπ','üî∂','üî∑','üî≥','üî≤','‚ñ™Ô∏è','‚ñ´Ô∏è','‚óæ','‚óΩ','‚óºÔ∏è','‚óªÔ∏è','üü•','üüß','üü®','üü©','üü¶','üü™','‚¨õ','‚¨ú','üü´','üîà','üîá','üîâ','üîä','üîî','üîï','üì£','üì¢','üëÅÔ∏è‚Äçüó®Ô∏è','üí¨','üí≠','üóØÔ∏è','‚ô†Ô∏è','‚ô£Ô∏è','‚ô•Ô∏è','‚ô¶Ô∏è','üÉè','üé¥','üÄÑ','üïê','üïë','üïí','üïì','üïî','üïï','üïñ','üïó','üïò','üïô','üïö','üïõ','üïú','üïù','üïû','üïü','üï†','üï°','üï¢','üï£','üï§','üï•','üï¶','üïß']
    };

    // Sticker data
    const stickerData = [
        { emoji: 'üéâ', text: 'Party!' },
        { emoji: '‚ù§Ô∏è', text: 'Love' },
        { emoji: 'üëç', text: 'Good!' },
        { emoji: 'üòç', text: 'Amazing!' },
        { emoji: 'üî•', text: 'Fire!' },
        { emoji: 'üíØ', text: 'Perfect!' },
        { emoji: 'üéä', text: 'Celebrate!' },
        { emoji: '‚ú®', text: 'Sparkle!' },
        { emoji: 'üåü', text: 'Star!' },
        { emoji: 'üöÄ', text: 'Launch!' },
        { emoji: 'üí™', text: 'Strong!' },
        { emoji: 'üéØ', text: 'Target!' },
        { emoji: '‚ö°', text: 'Lightning!' },
        { emoji: 'üåà', text: 'Rainbow!' },
        { emoji: 'üé™', text: 'Circus!' },
        { emoji: 'üé≠', text: 'Drama!' },
        { emoji: 'üé®', text: 'Art!' },
        { emoji: 'üéµ', text: 'Music!' },
        { emoji: 'üèÜ', text: 'Winner!' },
        { emoji: 'üéÅ', text: 'Gift!' },
        { emoji: 'üçï', text: 'Pizza!' },
        { emoji: '‚òï', text: 'Coffee!' },
        { emoji: 'üçî', text: 'Burger!' },
        { emoji: 'üéÇ', text: 'Birthday!' }
    ];

    // Initialize functionality
    initializeEmojiPicker();
    initializeStickerPicker();
    setupEventListeners();
    initializeNotifications();
    loadNotificationPreferences();
    setupActivityTracking();



    function initializeEmojiPicker() {
        // Load default category (smileys)
        loadEmojiCategory('smileys');
        
        // Category switching
        document.querySelectorAll('.emoji-category').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.emoji-category').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadEmojiCategory(btn.dataset.category);
            });
        });
    }

    function loadEmojiCategory(category) {
        const emojis = emojiData[category] || emojiData.smileys;
        emojiGrid.innerHTML = '';
        
        emojis.forEach(emoji => {
            const emojiElement = document.createElement('div');
            emojiElement.className = 'emoji-item';
            emojiElement.textContent = emoji;
            emojiElement.addEventListener('click', () => {
                insertEmoji(emoji);
            });
            emojiGrid.appendChild(emojiElement);
        });
    }

    function insertEmoji(emoji) {
        const cursorPos = messageInput.selectionStart;
        const textBefore = messageInput.value.substring(0, cursorPos);
        const textAfter = messageInput.value.substring(messageInput.selectionEnd);
        
        messageInput.value = textBefore + emoji + textAfter;
        messageInput.focus();
        
        // Set cursor position after the emoji
        messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
        
        // Hide emoji picker
        emojiPicker.classList.remove('show');
        
        // Auto-resize textarea
        autoResizeTextarea();
    }

    function initializeStickerPicker() {
        stickerData.forEach(sticker => {
            const stickerElement = document.createElement('div');
            stickerElement.className = 'sticker-item';
            stickerElement.innerHTML = `
                <div style="font-size: 2.5rem;">${sticker.emoji}</div>
                <div style="font-size: 0.8rem; margin-top: 5px;">${sticker.text}</div>
            `;
            stickerElement.addEventListener('click', () => {
                insertSticker(sticker);
            });
            stickerGrid.appendChild(stickerElement);
        });
    }

    function insertSticker(sticker) {
        const stickerText = `${sticker.emoji} ${sticker.text}`;
        messageInput.value = stickerText;
        messageInput.focus();
        
        // Hide sticker picker
        stickerPicker.classList.remove('show');
        
        // Auto-resize textarea
        autoResizeTextarea();
    }

    function setupEventListeners() {
        // Emoji button
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('show');
            stickerPicker.classList.remove('show');
        });

        // Sticker button
        stickerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            stickerPicker.classList.toggle('show');
            emojiPicker.classList.remove('show');
        });

        // Close pickers when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
                emojiPicker.classList.remove('show');
            }
            if (!stickerPicker.contains(e.target) && !stickerBtn.contains(e.target)) {
                stickerPicker.classList.remove('show');
            }
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', autoResizeTextarea);
    }

    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    }



    function displayMessages(messages) {
        const currentScrollHeight = messagesContainer.scrollHeight;
        const currentScrollTop = messagesContainer.scrollTop;
        const isScrolledToBottom = currentScrollTop + messagesContainer.clientHeight >= currentScrollHeight - 10;
        
        messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
            messagesContainer.innerHTML = '<div class="no-messages">No messages yet. Start the conversation! / ‡Æá‡Æ©‡Øç‡Æ©‡ØÅ‡ÆÆ‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡Æï‡Æ≥‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà. ‡Æâ‡Æ∞‡Øà‡ÆØ‡Ææ‡Æü‡Æ≤‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç!</div>';
            return;
        }
        
        messages.forEach(message => {
            addMessageToChat(message);
        });
        
        // Only scroll to bottom if user was already at bottom
        if (isScrolledToBottom) {
            scrollToBottom();
        }
    }

    function addMessageToChat(message) {
        const messageDiv = document.createElement('div');
        const isSent = message.sender_email === currentUserEmail;
        
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        
        const deleteButton = isSent ? 
            `<button class="delete-btn" onclick="deleteMessage(${message.id})">üóëÔ∏è</button>` : '';
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${message.message_text}
                <div class="message-info">
                    ${new Date(message.timestamp).toLocaleString('en-IN', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                    ${deleteButton}
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
    }

    function deleteMessage(messageId) {
        if (confirm('Are you sure you want to delete this message? / ‡Æá‡Æ®‡Øç‡Æ§ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà ‡Æ®‡Æø‡Æö‡Øç‡Æö‡ÆØ‡ÆÆ‡Ææ‡Æï ‡Æ®‡ØÄ‡Æï‡Øç‡Æï ‡Æµ‡Øá‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Ææ?')) {
            fetch(`/delete_message/${messageId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMessages(currentReceiver);
                } else {
                    alert('Error deleting message / ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà ‡Æ®‡ØÄ‡Æï‡Øç‡Æï‡ØÅ‡Æµ‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà');
                }
            })
            .catch(error => console.error('Error deleting message:', error));
        }
    }

    // Send message
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message && currentReceiver) {
            // Stop typing indicator
            if (isTyping) {
                isTyping = false;
                setTypingStatus(false);
            }
            
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    receiver_email: currentReceiver,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageInput.value = '';
                    autoResizeTextarea(); // Reset textarea height
                    loadMessagesWithNotifications(currentReceiver);
                    scrollToBottom();
                } else {
                    alert('Error sending message / ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡Æµ‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà');
                }
            })
            .catch(error => console.error('Error sending message:', error));
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Notification and Activity Functions
    function initializeNotifications() {
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                console.log('Notification permission:', permission);
            });
        }

        // Setup notification toggle
        if (notificationToggle) {
            notificationToggle.addEventListener('click', function() {
                const isActive = this.classList.contains('active');
                this.classList.toggle('active');
                notificationPreferences.desktop_notifications = !isActive;
                saveNotificationPreferences();
            });
        }

        // Setup sound toggle
        if (soundToggle) {
            soundToggle.addEventListener('click', function() {
                const isActive = this.classList.contains('active');
                this.classList.toggle('active');
                notificationPreferences.sound_notifications = !isActive;
                saveNotificationPreferences();
            });
        }
    }

    function loadNotificationPreferences() {
        fetch('/get_notification_preferences')
            .then(response => response.json())
            .then(prefs => {
                notificationPreferences = prefs;
                updateToggleStates();
            })
            .catch(error => console.error('Error loading preferences:', error));
    }

    function saveNotificationPreferences() {
        fetch('/set_notification_preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(notificationPreferences)
        })
        .catch(error => console.error('Error saving preferences:', error));
    }

    function updateToggleStates() {
        if (notificationToggle) {
            notificationToggle.classList.toggle('active', notificationPreferences.desktop_notifications);
        }
        if (soundToggle) {
            soundToggle.classList.toggle('active', notificationPreferences.sound_notifications);
        }
    }

    function showDesktopNotification(title, message, senderName) {
        if (!notificationPreferences.desktop_notifications) return;
        
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification(title, {
                body: message,
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üí¨</text></svg>',
                tag: 'chat-message'
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };

            // Auto-close after 5 seconds
            setTimeout(() => notification.close(), 5000);
        }
    }

    function playNotificationSound() {
        if (!notificationPreferences.sound_notifications) return;
        
        // Create audio context for notification sound
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        } catch (error) {
            console.log('Audio notification not supported');
        }
    }

    function setupActivityTracking() {
        // Update activity every 30 seconds
        activityInterval = setInterval(() => {
            updateActivity('online');
            updateUserStatuses(); // Update user list with latest statuses
        }, 30000);

        // Track typing
        if (messageInput) {
            messageInput.addEventListener('input', function() {
                if (!isTyping && currentReceiver) {
                    isTyping = true;
                    setTypingStatus(true);
                }
                
                // Clear existing timeout
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                }
                
                // Set new timeout to stop typing indicator
                typingTimeout = setTimeout(() => {
                    if (isTyping) {
                        isTyping = false;
                        setTypingStatus(false);
                    }
                }, 1000);
            });
        }

        // Update activity on page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                updateActivity('idle');
            } else {
                updateActivity('online');
            }
        });

        // Update user statuses every 10 seconds
        setInterval(updateUserStatuses, 10000);
    }

    function updateUserStatuses() {
        fetch('/get_users_status')
            .then(response => response.json())
            .then(data => {
                if (data.users) {
                    updateUserList(data.users);
                }
            })
            .catch(error => console.error('Error updating user statuses:', error));
    }

    function updateUserList(users) {
        users.forEach(user => {
            const userItem = document.querySelector(`[data-email="${user.email}"]`);
            if (userItem) {
                // Update online status indicator
                const statusIndicator = userItem.querySelector('.status-indicator');
                const userStatus = userItem.querySelector('.user-status');
                
                if (statusIndicator) {
                    statusIndicator.className = `status-indicator ${user.is_online ? 'status-online' : 'status-offline'}`;
                }
                
                if (userStatus) {
                    if (user.is_online) {
                        userStatus.innerHTML = `
                            <span class="status-indicator status-online"></span>
                            {{ get_text('online') }}
                        `;
                    } else {
                        const lastSeen = user.last_seen ? user.last_seen.substring(0, 16) : '';
                        userStatus.innerHTML = `
                            <span class="status-indicator status-offline"></span>
                            {{ get_text('last_seen') }} ${lastSeen}
                        `;
                    }
                }
                
                // Update unread badge
                let unreadBadge = userItem.querySelector('.unread-badge');
                if (user.unread_count > 0) {
                    if (!unreadBadge) {
                        unreadBadge = document.createElement('div');
                        unreadBadge.className = 'unread-badge';
                        userItem.appendChild(unreadBadge);
                    }
                    unreadBadge.textContent = user.unread_count;
                } else if (unreadBadge) {
                    unreadBadge.remove();
                }
            }
        });
    }

    function updateActivity(status = 'online') {
        fetch('/update_activity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                activity: status
            })
        })
        .catch(error => console.error('Error updating activity:', error));
    }

    function setTypingStatus(typing) {
        if (!currentReceiver) return;
        
        fetch('/set_typing_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target_user_email: currentReceiver,
                is_typing: typing
            })
        })
        .catch(error => console.error('Error setting typing status:', error));
    }

    function checkTypingStatus() {
        if (!currentReceiver) return;
        
        fetch(`/get_typing_status/${currentReceiver}`)
            .then(response => response.json())
            .then(data => {
                if (data.typing_users && data.typing_users.length > 0) {
                    const typingUser = data.typing_users[0];
                    document.getElementById('typing-user').textContent = typingUser.name;
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            })
            .catch(error => console.error('Error checking typing status:', error));
    }

    function showInAppNotification(title, message) {
        // Create in-app notification
        const notification = document.createElement('div');
        notification.className = 'notification-popup';
        notification.innerHTML = `
            <div class="notification-header">${title}</div>
            <div class="notification-body">${message}</div>
        `;
        
        document.body.appendChild(notification);
        
        // Show notification
        setTimeout(() => notification.classList.add('show'), 100);
        
        // Hide after 4 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => document.body.removeChild(notification), 300);
        }, 4000);
    }

    // Enhanced message loading with notifications
    function loadMessagesWithNotifications(receiverEmail) {
        fetch(`/get_messages/${receiverEmail}`)
            .then(response => response.json())
            .then(newMessages => {
                const previousMessageCount = messagesContainer.children.length;
                displayMessages(newMessages);
                
                // Check for new messages (only if chat is active)
                if (newMessages.length > previousMessageCount && currentReceiver === receiverEmail) {
                    const latestMessage = newMessages[newMessages.length - 1];
                    
                    // If message is from other user (not current user)
                    if (latestMessage.sender_email !== currentUserEmail) {
                        playNotificationSound();
                        
                        // Show desktop notification if window is not focused
                        if (document.hidden || !document.hasFocus()) {
                            showDesktopNotification(
                                `{{ get_text('new_message') }} ${latestMessage.sender_name}`,
                                latestMessage.message_text.substring(0, 50) + (latestMessage.message_text.length > 50 ? '...' : ''),
                                latestMessage.sender_name
                            );
                        } else {
                            // Show in-app notification if window is focused
                            showInAppNotification(
                                `{{ get_text('new_message') }} ${latestMessage.sender_name}`,
                                latestMessage.message_text.substring(0, 50) + (latestMessage.message_text.length > 50 ? '...' : '')
                            );
                        }
                        
                        // Mark messages as read
                        markMessagesAsRead(latestMessage.sender_email);
                    }
                }
                
                // Check typing status
                checkTypingStatus();
            })
            .catch(error => console.error('Error loading messages:', error));
    }

    function markMessagesAsRead(senderEmail) {
        fetch('/mark_messages_read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sender_email: senderEmail
            })
        })
        .catch(error => console.error('Error marking messages as read:', error));
    }

    // Update selectUser function to use enhanced message loading
    function selectUserEnhanced(email, name) {
        // Stop previous polling if any
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
        }
        
        // Stop typing for previous conversation
        if (isTyping) {
            isTyping = false;
            setTypingStatus(false);
        }
        
        currentReceiver = email;
        
        chatWith.textContent = `{% if current_language == 'ta' %}${name} ‡Æâ‡Æü‡Æ©‡Øç ‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà{% else %}{{ get_text('chat_with') }} ${name}{% endif %}`;
        inputArea.style.display = 'flex';
        
        loadMessagesWithNotifications(email);
        
        // Start polling for new messages every 2 seconds
        messagePollingInterval = setInterval(() => {
            loadMessagesWithNotifications(email);
        }, 2000);
        
        // Mark existing messages as read
        markMessagesAsRead(email);
    }

    // Update user selection to use enhanced function
    userItems.forEach(item => {
        item.addEventListener('click', () => {
            userItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            
            const userEmail = item.dataset.email;
            const userName = item.dataset.name;
            
            selectUserEnhanced(userEmail, userName);
        });
    });

    // Clean up polling when page is closed
    window.addEventListener('beforeunload', () => {
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
        }
        if (activityInterval) {
            clearInterval(activityInterval);
        }
        if (typingTimeout) {
            clearTimeout(typingTimeout);
        }
        
        // Set user as offline
        updateActivity('offline');
    });
</script>
{% endblock %}