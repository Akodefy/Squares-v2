import{j as e}from"./ui-CMGlPv8M.js";import{r as i}from"./router-02yfTqxa.js";import{t as h,a3 as je,a4 as Ne,Q,f as A,a as N,e as y,a5 as ye,a6 as ve,a7 as L,B as f,J as be,I as we,r as Y,s as K,v as W,w as X,x as g,a8 as Z,a9 as ee,aa as se,ab as D,ac as Se,ad as Me,ae as Te,af as te,T as Ce,ag as Re}from"./index-DGiQKbnC.js";import{S as ae}from"./scroll-area-Dc6MWRfJ.js";import{A as Ae,b as De,c as Ee,d as Fe,e as ke,f as _e,g as $e,h as qe}from"./alert-dialog-Cen20FWz.js";import{m as E}from"./messageService-B5jDnZ0Q.js";import{R as Pe}from"./refresh-cw-bU1KP5oX.js";import{E as Ie}from"./ellipsis-vertical-BahDdS2u.js";import{T as Le}from"./triangle-alert-BRpipt4V.js";import{T as Oe}from"./trash-2-DzllJ_4S.js";import{S as Ue}from"./send-DxBMk8cd.js";import"./vendor-Dazix4UH.js";const Be="https://api.akodefy.com/api";class Ve{async makeRequest(a,t={}){try{const l=localStorage.getItem("token"),n=await fetch(`${Be}${a}`,{headers:{"Content-Type":"application/json",...l&&{Authorization:`Bearer ${l}`},...t.headers},...t});if(!n.ok){const r=await n.json().catch(()=>({}));throw new Error(r.message||`HTTP error! status: ${n.status}`)}return await n.json()}catch(l){throw console.error("API request failed:",l),l}}async getMessages(a={}){try{const t=new URLSearchParams;Object.entries(a).forEach(([r,p])=>{p!=null&&p!==""&&t.append(r,p.toString())});const l=t.toString(),n=`/admin/messages${l?`?${l}`:""}`;return await this.makeRequest(n)}catch(t){const l=t instanceof Error?t.message:"Failed to fetch messages";throw h({title:"Error",description:l,variant:"destructive"}),t}}async getMessageStats(){try{const a=await this.makeRequest("/admin/messages/stats");if(a.success)return a.data;throw new Error("Failed to fetch message statistics")}catch(a){const t=a instanceof Error?a.message:"Failed to fetch message statistics";throw h({title:"Error",description:t,variant:"destructive"}),a}}async updateMessageStatus(a,t){try{const l=await this.makeRequest(`/admin/messages/${a}/status`,{method:"PATCH",body:JSON.stringify({status:t})});if(l.success)return h({title:"Success",description:l.message}),l.data.message;throw new Error("Failed to update message status")}catch(l){const n=l instanceof Error?l.message:"Failed to update message status";throw h({title:"Error",description:n,variant:"destructive"}),l}}async deleteMessage(a){try{const t=await this.makeRequest(`/admin/messages/${a}`,{method:"DELETE"});if(t.success){h({title:"Success",description:t.message});return}throw new Error("Failed to delete message")}catch(t){const l=t instanceof Error?t.message:"Failed to delete message";throw h({title:"Error",description:l,variant:"destructive"}),t}}async sendReply(a,t,l){try{const n=await this.makeRequest(`/admin/messages/${a}/reply`,{method:"POST",body:JSON.stringify({content:t,subject:l})});if(n.success)return h({title:"Success",description:n.message}),n.data.reply;throw new Error("Failed to send reply")}catch(n){const r=n instanceof Error?n.message:"Failed to send reply";throw h({title:"Error",description:r,variant:"destructive"}),n}}getSenderName(a){const t=a.sender.profile;return t?.firstName&&t?.lastName?`${t.firstName} ${t.lastName}`:a.sender.email}getRecipientName(a){const t=a.recipient.profile;return t?.firstName&&t?.lastName?`${t.firstName} ${t.lastName}`:a.recipient.email}formatDate(a){const t=new Date(a),n=(new Date().getTime()-t.getTime())/(1e3*60*60);return n<1?`${Math.floor(n*60)} minutes ago`:n<24?`${Math.floor(n)} hours ago`:n<48?"Yesterday":t.toLocaleDateString("en-IN",{year:"numeric",month:"short",day:"numeric"})}getStatusColor(a){return{unread:"bg-blue-100 text-blue-800",read:"bg-green-100 text-green-800",replied:"bg-purple-100 text-purple-800",flagged:"bg-red-100 text-red-800",archived:"bg-gray-100 text-gray-800"}[a]||"bg-gray-100 text-gray-800"}getPriorityColor(a){return{urgent:"bg-red-500 text-white",high:"bg-orange-500 text-white",medium:"bg-yellow-500 text-white",low:"bg-green-500 text-white"}[a]||"bg-gray-500 text-white"}getTypeDisplayName(a){return{inquiry:"General Inquiry",lead:"Lead",property_inquiry:"Property Inquiry",general:"General",support:"Support",complaint:"Complaint"}[a]||a}}const m=new Ve,rs=()=>{const{isConnected:F}=je(),[a,t]=i.useState([]),[l,n]=i.useState([]),[r,p]=i.useState(null),[O,U]=i.useState(!0),[o,re]=i.useState(null),[w,le]=i.useState("all"),[k,ne]=i.useState(""),[_,He]=i.useState("all"),[S,ie]=i.useState("all"),[M,ce]=i.useState("all"),[T,$]=i.useState(""),[q,C]=i.useState(null),[x,oe]=i.useState({}),[B,R]=i.useState(!1),[de,ze]=i.useState(!1),v=i.useRef(null),V=i.useRef(null),[P,me]=i.useState({currentPage:1,totalPages:1,totalMessages:0,hasNext:!1,hasPrev:!1,limit:20});Ne({refreshConversations:()=>{d()},onNewMessage:s=>{d(),j()},onMessageRead:()=>{d(),j()}}),i.useEffect(()=>{d(),j()},[]),i.useEffect(()=>{if(a.length>0){H();const s=setInterval(H,1e4);return()=>clearInterval(s)}},[a]);const H=async()=>{const s={},c=new Set(a.map(u=>u.sender._id));for(const u of c)try{const I=await E.getUserStatus(u);s[u]=I}catch(I){console.error(`Failed to load status for user ${u}:`,I)}oe(s)},xe=()=>{V.current?.scrollIntoView({behavior:"smooth"})},ue=s=>{$(s),v.current&&clearTimeout(v.current),s.trim()&&r?(B||R(!0),v.current=setTimeout(()=>{R(!1)},3e3)):R(!1)};i.useEffect(()=>()=>{v.current&&clearTimeout(v.current)},[]);const d=async(s={})=>{try{U(!0);const c={page:P.currentPage,limit:P.limit,status:_!=="all"?_:void 0,type:S!=="all"?S:void 0,priority:M!=="all"?M:void 0,search:k||void 0,...s},u=await m.getMessages(c);u.success&&(t(u.data.messages),me(u.data.pagination))}catch(c){console.error("Failed to load messages:",c)}finally{U(!1)}},j=async()=>{try{const s=await m.getMessageStats();re(s)}catch(s){console.error("Failed to load message stats:",s)}};i.useEffect(()=>{d()},[w,_,S,M,k,P.currentPage]),i.useEffect(()=>{let s=a;switch(w){case"unread":s=s.filter(c=>c.status==="unread");break;case"flagged":s=s.filter(c=>c.status==="flagged");break;case"inquiries":s=s.filter(c=>["inquiry","lead","property_inquiry"].includes(c.type));break;case"support":s=s.filter(c=>["support","complaint"].includes(c.type));break}n(s)},[a,w]);const b=s=>m.getSenderName(s),z=s=>m.formatDate(s),J=s=>m.getStatusColor(s),G=s=>m.getPriorityColor(s),ge=async s=>{try{await m.updateMessageStatus(s,"read"),d(),j()}catch(c){console.error("Failed to mark message as read:",c)}},he=async s=>{try{await m.updateMessageStatus(s,"flagged"),d(),j()}catch(c){console.error("Failed to flag message:",c)}},fe=async s=>{try{await m.deleteMessage(s),r?._id===s&&p(null),d(),j(),C(null)}catch(c){console.error("Failed to delete message:",c)}},pe=async()=>{if(!(!r||!T.trim()))try{B&&R(!1),await m.sendReply(r._id,T.trim()),$(""),d(),j(),setTimeout(()=>xe(),100)}catch(s){console.error("Failed to send reply:",s)}};return O?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Q,{className:"h-6 w-6 animate-spin"}),e.jsx("span",{children:"Loading messages..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-3 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${F?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-sm text-muted-foreground",children:F?"Real-time messaging active":"Offline mode"})]}),O&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Q,{className:"w-4 h-4 animate-spin"}),"Loading messages..."]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage and respond to user messages and inquiries"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(A,{variant:"outline",onClick:()=>d(),children:[e.jsx(Pe,{className:"w-4 h-4 mr-2"}),"Refresh"]})})]}),o&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 lg:grid-cols-7 gap-4",children:[e.jsx(N,{children:e.jsxs(y,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:o.totalMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total Messages"})]})}),e.jsx(N,{children:e.jsxs(y,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:o.unreadMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Unread"})]})}),e.jsx(N,{children:e.jsxs(y,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:o.repliedMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Replied"})]})}),e.jsx(N,{children:e.jsxs(y,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:o.flaggedMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Flagged"})]})}),e.jsx(N,{children:e.jsxs(y,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:o.todayMessages}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Today"})]})}),e.jsx(N,{children:e.jsxs(y,{className:"p-4 text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-teal-600",children:[o.responseRate,"%"]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Response Rate"})]})}),e.jsx(N,{children:e.jsxs(y,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-indigo-600",children:o.avgResponseTime}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Avg Response"})]})})]}),e.jsxs("div",{className:"h-[calc(100vh-16rem)] flex gap-6",children:[e.jsxs("div",{className:"w-1/3 border-r border-border",children:[e.jsx(ye,{value:w,onValueChange:le,className:"w-full",children:e.jsxs(ve,{className:"w-full grid grid-cols-3",children:[e.jsxs(L,{value:"all",className:"text-xs",children:["All ",o&&o.totalMessages>0&&e.jsx(f,{className:"ml-1 text-xs",variant:"secondary",children:o.totalMessages})]}),e.jsxs(L,{value:"unread",className:"text-xs",children:["Unread ",o&&o.unreadMessages>0&&e.jsx(f,{className:"ml-1 text-xs bg-red-500 text-white",children:o.unreadMessages})]}),e.jsxs(L,{value:"flagged",className:"text-xs",children:["Flagged ",o&&o.flaggedMessages>0&&e.jsx(f,{className:"ml-1 text-xs bg-orange-500 text-white",children:o.flaggedMessages})]})]})}),e.jsxs("div",{className:"p-4 border-b border-border space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(we,{placeholder:"Search conversations...",value:k,onChange:s=>ne(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Y,{value:S,onValueChange:ie,children:[e.jsx(K,{className:"flex-1",children:e.jsx(W,{placeholder:"Type"})}),e.jsxs(X,{children:[e.jsx(g,{value:"all",children:"All"}),e.jsx(g,{value:"inquiry",children:"Inquiry"}),e.jsx(g,{value:"property_inquiry",children:"Property"}),e.jsx(g,{value:"support",children:"Support"})]})]}),e.jsxs(Y,{value:M,onValueChange:ce,children:[e.jsx(K,{className:"flex-1",children:e.jsx(W,{placeholder:"Priority"})}),e.jsxs(X,{children:[e.jsx(g,{value:"all",children:"All"}),e.jsx(g,{value:"urgent",children:"Urgent"}),e.jsx(g,{value:"high",children:"High"}),e.jsx(g,{value:"medium",children:"Medium"}),e.jsx(g,{value:"low",children:"Low"})]})]})]})]}),e.jsx(ae,{className:"h-[calc(100%-12rem)]",children:e.jsx("div",{className:"p-2 space-y-1",children:l.map(s=>e.jsx("div",{className:`p-3 rounded-lg cursor-pointer transition-colors hover:bg-accent/50 ${r?._id===s._id?"bg-accent":""}`,onClick:()=>{p(s),s.status==="unread"&&ge(s._id)},children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(Z,{className:"w-10 h-10",children:[e.jsx(ee,{src:s.sender.profile?.avatar}),e.jsx(se,{children:b(s).charAt(0).toUpperCase()})]}),x[s.sender._id]?.isOnline?e.jsx("div",{title:"Online",children:e.jsx(D,{className:"absolute -bottom-1 -right-1 w-3 h-3 fill-green-500 text-green-500 border-2 border-background rounded-full"})}):e.jsx("div",{title:`Last seen ${x[s.sender._id]?.lastSeen?E.formatTime(x[s.sender._id].lastSeen):"recently"}`,children:e.jsx(D,{className:"absolute -bottom-1 -right-1 w-3 h-3 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})}),s.status==="unread"&&e.jsx("div",{className:"absolute -top-1 -left-1 w-3 h-3 rounded-full bg-red-500"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:b(s)}),e.jsx("span",{className:"text-xs text-muted-foreground",children:z(s.createdAt)})]}),s.subject&&e.jsx("p",{className:"text-xs font-medium text-primary mb-1 truncate",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.content}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx(f,{className:`text-xs ${G(s.priority)}`,children:s.priority}),e.jsx(f,{className:`text-xs ${J(s.status)}`,children:s.status})]}),e.jsxs(Se,{children:[e.jsx(Me,{asChild:!0,children:e.jsx(A,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:e.jsx(Ie,{className:"w-3 h-3"})})}),e.jsxs(Te,{align:"end",children:[e.jsxs(te,{onClick:()=>he(s._id),children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Flag"]}),e.jsxs(te,{className:"text-red-600",onSelect:c=>{c.preventDefault(),C(s._id)},children:[e.jsx(Oe,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]})]})]})]})},s._id))})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsxs(Z,{className:"w-10 h-10",children:[e.jsx(ee,{src:r.sender.profile?.avatar}),e.jsx(se,{children:b(r).charAt(0).toUpperCase()})]}),x[r.sender._id]?.isOnline?e.jsx("div",{title:"Online",children:e.jsx(D,{className:"absolute -bottom-1 -right-1 w-3 h-3 fill-green-500 text-green-500 border-2 border-background rounded-full"})}):e.jsx("div",{title:`Last seen ${x[r.sender._id]?.lastSeen?E.formatTime(x[r.sender._id].lastSeen):"recently"}`,children:e.jsx(D,{className:"absolute -bottom-1 -right-1 w-3 h-3 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:b(r)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:x[r.sender._id]?.isOnline?"Online":`Last seen ${x[r.sender._id]?.lastSeen?E.formatTime(x[r.sender._id].lastSeen):"recently"}`})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:G(r.priority),children:r.priority}),e.jsx(f,{className:J(r.status),children:r.status})]})]}),r.property&&e.jsxs("div",{className:"mt-3 p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium",children:"Related Property:"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r.property.title})]})]}),e.jsx(ae,{className:"flex-1 p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"max-w-[70%] bg-muted p-3 rounded-lg",children:[r.subject&&e.jsx("p",{className:"font-medium text-sm mb-2",children:r.subject}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:r.content}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:z(r.createdAt)}),e.jsx(f,{variant:"outline",className:"text-xs",children:r.type?.replace("_"," ")||"general"})]})]})}),de&&e.jsx("div",{className:"flex justify-start animate-fadeIn",children:e.jsx("div",{className:"bg-muted/80 px-4 py-2 rounded-lg border border-border/50",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground italic",children:[b(r)," is typing..."]})]})})}),e.jsx("div",{ref:V})]})}),e.jsx("div",{className:"p-4 border-t border-border",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ce,{placeholder:"Type your reply...",value:T,onChange:s=>ue(s.target.value),rows:3,className:"resize-none"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(A,{onClick:pe,disabled:!T.trim(),className:"flex-1",children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"Send Reply"]}),e.jsx(A,{variant:"outline",onClick:()=>$(""),children:"Clear"})]})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Re,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a Conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a message from the list to start chatting"})]})})})]}),e.jsx(Ae,{open:!!q,onOpenChange:s=>{s||C(null)},children:e.jsxs(De,{className:"sm:max-w-[425px]",children:[e.jsxs(Ee,{children:[e.jsx(Fe,{children:"Delete Message"}),e.jsx(ke,{children:"Are you sure you want to delete this message? This action cannot be undone."})]}),e.jsxs(_e,{children:[e.jsx($e,{onClick:()=>C(null),children:"Cancel"}),e.jsx(qe,{onClick:()=>{q&&fe(q)},className:"bg-red-600 hover:bg-red-700 focus:ring-red-600",children:"Delete Message"})]})]})})]})};export{rs as default};
