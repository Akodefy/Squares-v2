import{j as e}from"./ui-CMGlPv8M.js";import{r}from"./router-02yfTqxa.js";import{a3 as ye,u as we,a4 as be,t as h,ag as k,r as Ce,s as Se,v as Me,w as ke,x as T,a as Z,b as ee,c as Te,B as A,J as Ae,I as Ie,e as I,Q as se,a8 as te,a9 as ae,aa as re,ac as F,ad as P,f as m,ae as U,af as u,aB as ie,D as Fe,z as ne,P as Pe,i as Ue,k as _e,h as De,X as ze,T as $e}from"./index-DGiQKbnC.js";import{S as le}from"./scroll-area-Dc6MWRfJ.js";import{m as o}from"./messageService-B5jDnZ0Q.js";import{u as Ee}from"./use-mobile-CFRG74LA.js";import{E as _}from"./ellipsis-vertical-BahDdS2u.js";import{A as ce,C as oe}from"./check-check-BZ-OxMqH.js";import{T as D}from"./trash-2-DzllJ_4S.js";import{P as de}from"./paperclip-BX5zHL2E.js";import{I as Re}from"./image-XeenX5rY.js";import{S as Le}from"./send-DxBMk8cd.js";import"./vendor-Dazix4UH.js";const ls=()=>{const{isConnected:Be}=ye(),{user:me}=we(),p=Ee(),[i,z]=r.useState(null),[f,$]=r.useState(""),[C,xe]=r.useState(""),[j,E]=r.useState([]),[he,g]=r.useState([]),[ue,R]=r.useState(!0),[N,L]=r.useState(!1),[b,pe]=r.useState("all"),[v,S]=r.useState([]),[y,B]=r.useState(!1),[Oe,Ve]=r.useState(!1),[fe,Qe]=r.useState(!1),[O,je]=r.useState({}),[He,Ke]=r.useState({}),[V,Q]=r.useState(!0),H=r.useRef(null),K=r.useRef(null);r.useRef(null),r.useRef(null),r.useRef(null),be({refreshConversations:()=>{w()},onNewMessage:s=>{s.conversationId===i&&M(i),w()},onMessageRead:s=>{s.conversationId===i&&M(i)}});const w=async()=>{try{R(!0);const s=await o.getConversations({status:b!=="all"?b:void 0,limit:50});E(s.conversations)}catch(s){console.error("Failed to load conversations:",s),h({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{R(!1)}},M=async s=>{try{g([]);const t=await o.getConversationMessages(s,1,50,!0);t&&(g(t.messages),await o.updateActiveStatus(s,"online"),w())}catch(t){console.error("Failed to load messages:",t)}},q=async()=>{const s={};for(const t of j)try{const a=await o.getUserStatus(t.otherUser._id);s[t.otherUser._id]=a}catch(a){console.error(`Failed to load status for user ${t.otherUser._id}:`,a)}je(s)};r.useEffect(()=>{w()},[b]),r.useEffect(()=>{i?(M(i),p&&Q(!1)):g([])},[i]),r.useEffect(()=>{if(j.length>0){q();const s=setInterval(()=>{q()},3e4);return()=>clearInterval(s)}},[j]);const l=j.find(s=>(s.id||s._id)===i),J=async()=>{if(!(!f.trim()&&v.length===0)){if(!i){console.error("No conversation selected");return}try{L(!0);const s=[];if(v.length>0){B(!0);for(const c of v)try{const d=await o.uploadAttachment(c);s.push(d)}catch(d){console.error(`Failed to upload ${c.name}:`,d)}B(!1)}if(!i||!l)throw new Error("No conversation selected");const t=i,a=l.otherUser._id;await o.updateActiveStatus(t,"online");const n=await o.sendMessage(t,f.trim(),a,s);g(c=>[...c,n]),$(""),S([]),w()}catch(s){console.error("Failed to send message:",s)}finally{L(!1)}}},ge=async()=>{i&&await o.updateActiveStatus(i,"typing")},W=async()=>{i&&await o.updateActiveStatus(i,"online")};r.useEffect(()=>{let s;return f.trim()?(ge(),s&&clearTimeout(s),s=setTimeout(()=>{W()},2e3)):W(),()=>{s&&clearTimeout(s)}},[f]),r.useEffect(()=>()=>{i&&o.updateActiveStatus(i,"offline")},[i]);const X=(s,t)=>{const a=s.target.files;if(!a)return;const n=Array.from(a),c=[];for(const d of n){if(d.size>10*1024*1024){h({title:"File too large",description:`${d.name} exceeds 10MB limit`,variant:"destructive"});continue}if(t==="image"){if(!d.type.startsWith("image/")){h({title:"Invalid file type",description:`${d.name} is not an image`,variant:"destructive"});continue}}else if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(d.type)){h({title:"Invalid file type",description:`${d.name} is not a supported document type`,variant:"destructive"});continue}c.push(d)}S(d=>[...d,...c]),s.target&&(s.target.value="")},ve=s=>{S(t=>t.filter((a,n)=>n!==s))},Y=async s=>{if(window.confirm("Are you sure you want to delete this conversation? This action cannot be undone."))try{await o.deleteConversation(s),E(t=>t.filter(a=>(a.id||a._id)!==s)),i===s&&(z(null),g([])),h({title:"Success",description:"Conversation deleted successfully!"})}catch(t){console.error("Failed to delete conversation:",t)}},Ne=async s=>{if(window.confirm("Are you sure you want to delete this message? This action cannot be undone."))try{await o.deleteMessage(s),g(t=>t.filter(a=>a._id!==s)),h({title:"Success",description:"Message deleted successfully!"})}catch(t){console.error("Failed to delete message:",t)}},x=s=>s.otherUser||{_id:"",name:"Unknown User",email:""},G=j.filter(s=>{const a=x(s).name||"",n=s.property?.title||"";return a.toLowerCase().includes(C.toLowerCase())||n.toLowerCase().includes(C.toLowerCase())});return e.jsxs("div",{className:"space-y-6 pt-16",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(k,{className:"w-8 h-8 text-primary"}),"Messages"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Communicate with property agents and owners"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(Ce,{value:b,onValueChange:pe,children:[e.jsx(Se,{className:"w-[180px]",children:e.jsx(Me,{placeholder:"Filter by status"})}),e.jsxs(ke,{children:[e.jsx(T,{value:"all",children:"All Messages"}),e.jsx(T,{value:"unread",children:"Unread"}),e.jsx(T,{value:"read",children:"Read"})]})]})})]}),e.jsxs("div",{className:`grid gap-6 h-[calc(100vh-12rem)] ${p?"grid-cols-1":"lg:grid-cols-3"}`,children:[e.jsxs(Z,{className:`${p?V?"block":"hidden":"lg:col-span-1"}`,children:[e.jsxs(ee,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Te,{className:"text-lg",children:"Conversations"}),e.jsx(A,{variant:"secondary",children:j.length})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ae,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Ie,{type:"text",placeholder:"Search conversations...",className:"pl-10",value:C,onChange:s=>xe(s.target.value)})]})]}),e.jsx(I,{className:"p-0",children:e.jsx(le,{className:"h-[calc(100vh-20rem)]",children:e.jsx("div",{className:"space-y-1 p-3",children:ue?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(se,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):G.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(k,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start by sending a message to a property"})]}):G.map(s=>{const t=x(s),a=t.name||"Unknown User",n=s.id||s._id||"";return e.jsx("div",{className:`group p-3 rounded-lg cursor-pointer transition-colors ${i===n?"bg-primary/10 border border-primary/20":"hover:bg-muted/50"}`,onClick:()=>z(n),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(te,{className:"w-12 h-12",children:[e.jsx(ae,{src:void 0}),e.jsx(re,{children:a.split(" ").map(c=>c[0]).join("")})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-semibold text-sm truncate",children:a}),O[t._id]?.isOnline&&e.jsx("span",{className:"text-[10px] text-green-600 font-medium",children:"● Online"})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:o.formatTime(s.lastMessage.createdAt)})]}),s.property&&e.jsx("p",{className:"text-xs text-primary font-medium mb-1 truncate",children:s.property.title}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.lastMessage.message}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[s.unreadCount>0&&e.jsx(A,{className:"bg-primary text-white text-xs px-2 py-1",children:s.unreadCount}),e.jsxs(F,{children:[e.jsx(P,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:c=>c.stopPropagation(),children:e.jsx(_,{className:"w-3 h-3"})})}),e.jsxs(U,{align:"end",children:[e.jsxs(u,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(u,{children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Archive"]}),e.jsxs(u,{className:"text-red-600 focus:text-red-600",onClick:c=>{c.stopPropagation(),Y(n)},children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]})]})},n)})})})})]}),e.jsx(Z,{className:`${p?V?"hidden":"block":"lg:col-span-2"}`,children:l?e.jsxs(e.Fragment,{children:[e.jsxs(ee,{className:"pb-3 border-b",children:[p&&e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>Q(!0),className:"p-2",children:e.jsx(Fe,{className:"w-4 h-4"})}),e.jsx("span",{className:"text-sm font-medium",children:"Back to Conversations"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"relative",children:e.jsxs(te,{className:"w-10 h-10",children:[e.jsx(ae,{src:void 0}),e.jsx(re,{children:x(l).name.split(" ").map(s=>s[0]).join("")})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:x(l).name}),O[x(l)._id]?.isOnline&&e.jsx("span",{className:"text-xs text-green-600 font-medium",children:"● Active now"})]}),l.property&&e.jsx("p",{className:"text-sm text-muted-foreground",children:l.property.title})]})]}),e.jsxs("div",{className:"flex gap-2",children:[x(l).phone?p?e.jsx(m,{size:"sm",variant:"outline",asChild:!0,children:e.jsx("a",{href:`tel:${x(l).phone}`,children:e.jsx(ne,{className:"w-4 h-4"})})}):e.jsxs(Pe,{children:[e.jsx(Ue,{asChild:!0,children:e.jsx(m,{size:"sm",variant:"outline",title:"View phone number",children:e.jsx(ne,{className:"w-4 h-4"})})}),e.jsx(_e,{className:"w-auto p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Phone Number"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-lg font-semibold",children:x(l).phone}),e.jsx(m,{size:"sm",variant:"outline",onClick:()=>{navigator.clipboard.writeText(x(l).phone||""),h({title:"Copied!",description:"Phone number copied to clipboard"})},children:"Copy"})]})]})})]}):null,e.jsxs(F,{children:[e.jsx(P,{asChild:!0,children:e.jsx(m,{size:"sm",variant:"outline",children:e.jsx(_,{className:"w-4 h-4"})})}),e.jsxs(U,{align:"end",children:[e.jsxs(u,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(u,{children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Archive Conversation"]}),e.jsxs(u,{className:"text-red-600 focus:text-red-600",onClick:()=>Y(i),children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]})]}),l.property&&e.jsx("div",{className:"px-6 py-3 bg-muted/30 border-b",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm",children:l.property.title})]}),e.jsxs("span",{className:"text-sm font-semibold text-primary",children:["₹",l.property.price.toLocaleString("en-IN")]})]})}),e.jsxs(I,{className:"p-0",children:[e.jsx(le,{className:"h-[calc(100vh-28rem)] p-4",children:e.jsxs("div",{className:"space-y-4",children:[he.map(s=>{const t=typeof s.sender=="string"?s.sender:s.sender._id,a=me?.id===t;return e.jsx("div",{className:`group flex ${a?"justify-end":"justify-start"} hover:bg-muted/30 rounded-lg p-1 transition-colors`,children:e.jsxs("div",{className:`max-w-[70%] p-3 rounded-lg ${a?"bg-primary text-primary-foreground":"bg-muted"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:s.attachments.map((n,c)=>e.jsx("div",{children:n.type==="image"?e.jsx("a",{href:n.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:n.url,alt:n.name,className:"max-w-full rounded border border-border cursor-pointer hover:opacity-90",style:{maxHeight:"200px"}})}):e.jsxs("a",{href:n.url,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 p-2 rounded border ${a?"border-primary-foreground/20 hover:bg-primary-foreground/10":"border-border bg-background hover:bg-muted"}`,children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm truncate",children:n.name})]})},c))}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs opacity-70",children:o.formatTime(s.createdAt)}),a&&e.jsx(A,{variant:"outline",className:"text-xs px-1 py-0",children:"You"})]}),e.jsx("div",{className:"flex items-center gap-1",children:a&&e.jsxs(e.Fragment,{children:[s.read?e.jsx(oe,{className:"w-3 h-3 text-blue-500"}):e.jsx(oe,{className:"w-3 h-3 text-gray-400"}),e.jsxs(F,{children:[e.jsx(P,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-50 group-hover:opacity-100 transition-opacity hover:bg-destructive/10",title:"Message options",children:e.jsx(_,{className:"w-3 h-3"})})}),e.jsx(U,{align:"end",children:e.jsxs(u,{className:"text-red-600 focus:text-red-600",onClick:()=>Ne(s._id),children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Delete Message"]})})]})]})})]})]})},s._id)}),fe&&e.jsx("div",{className:"flex justify-start",children:e.jsx("div",{className:"bg-muted p-3 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:[x(l).name," is typing..."]})]})})})]})}),e.jsxs("div",{className:"p-4 border-t",children:[v.length>0&&e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:v.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-muted px-3 py-2 rounded-lg",children:[e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name}),e.jsx(m,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>ve(t),children:e.jsx(ze,{className:"w-3 h-3"})})]},t))}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("input",{ref:H,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:s=>X(s,"document"),multiple:!0}),e.jsx("input",{ref:K,type:"file",className:"hidden",accept:"image/*",onChange:s=>X(s,"image"),multiple:!0}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>H.current?.click(),disabled:y||N,title:"Attach document",children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx(m,{size:"sm",variant:"outline",onClick:()=>K.current?.click(),disabled:y||N,title:"Attach image",children:e.jsx(Re,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1",children:e.jsx($e,{placeholder:"Type your message...",value:f,onChange:s=>$(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),J())},className:"min-h-[40px] resize-none",disabled:N||y})}),e.jsx(m,{onClick:J,disabled:!f.trim()&&v.length===0||N||y,children:N||y?e.jsx(se,{className:"w-4 h-4 animate-spin"}):e.jsx(Le,{className:"w-4 h-4"})})]})]})]})]}):e.jsx(I,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(k,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the left to start messaging"})]})})})]})]})};export{ls as default};
