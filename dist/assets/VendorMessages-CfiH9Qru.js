import{j as e}from"./ui-CMGlPv8M.js";import{r}from"./router-02yfTqxa.js";import{G as ue,u as xe,t as m,J as he,I as pe,a8 as $,a9 as O,aa as R,ab as N,B as fe,f as u,z as _,P as ge,i as be,k as je,ac as B,ad as V,ae as q,af as y,aB as ve,T as Ne,n as ye,ag as we,l as Se}from"./index-DGiQKbnC.js";import{S as G}from"./scroll-area-Dc6MWRfJ.js";import{m as l}from"./messageService-B5jDnZ0Q.js";import{u as ke}from"./use-mobile-CFRG74LA.js";import{E as H}from"./ellipsis-vertical-BahDdS2u.js";import{A as Ce,C as K}from"./check-check-BZ-OxMqH.js";import{P as Q}from"./paperclip-BX5zHL2E.js";import{I as Me}from"./image-XeenX5rY.js";import{S as _e}from"./send-DxBMk8cd.js";import"./vendor-Dazix4UH.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=ue("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]),Ge=()=>{const{user:W}=xe(),Y=ke(),[n,w]=r.useState(null),[f,A]=r.useState(""),[h,X]=r.useState(""),[Z,T]=r.useState(!0),[g,S]=r.useState([]),[ee,v]=r.useState([]),[se,U]=r.useState(!1),[b,k]=r.useState([]),[j,F]=r.useState(!1),[Ae,Te]=r.useState(!1),[te,Ue]=r.useState(!1),[o,ae]=r.useState({}),I=r.useRef(null),L=r.useRef(null),re=r.useRef(null);r.useRef(null),r.useRef(null),r.useEffect(()=>{C()},[]),r.useEffect(()=>{C()},[h]),r.useEffect(()=>{if(g.length>0){P();const s=setInterval(P,1e4);return()=>clearInterval(s)}},[g]),r.useEffect(()=>{n&&ie(n)},[n]);const C=async()=>{try{T(!0);const s={page:1,limit:50,...h&&{search:h}},t=await l.getConversations(s);S(t.conversations),!n&&t.conversations.length>0&&w(t.conversations[0].id||t.conversations[0]._id||"")}catch(s){console.error("Failed to load conversations:",s),m({title:"Error",description:"Failed to load conversations. Please try again.",variant:"destructive"})}finally{T(!1)}},ie=async s=>{try{U(!0);const t=await l.getConversationMessages(s,1,50,!0);t&&(v(t.messages),await l.updateActiveStatus(s,"online"),C())}catch(t){console.error("Failed to load messages:",t)}finally{U(!1)}},P=async()=>{const s={};for(const t of g)try{const a=await l.getUserStatus(t.otherUser._id);s[t.otherUser._id]=a}catch(a){console.error(`Failed to load status for user ${t.otherUser._id}:`,a)}ae(s)},E=async()=>{if(!f.trim()&&b.length===0||!n)return;const s=g.find(t=>(t.id||t._id)===n);if(s)try{F(!0),await l.updateActiveStatus(n,"online");const t=[];for(const i of b){const d=await l.uploadAttachment(i);t.push(d)}const a=await l.sendMessage(n,f.trim()||"(Attachment)",s.otherUser._id,t);v(i=>[...i,a]),A(""),k([]),S(i=>i.map(d=>(d.id||d._id)===n?{...d,lastMessage:{_id:a._id,message:a.message,createdAt:a.createdAt,isFromMe:!0},updatedAt:a.createdAt}:d)),m({title:"Success",description:"Message sent successfully!"})}catch(t){console.error("Failed to send message:",t),m({title:"Error",description:"Failed to send message. Please try again.",variant:"destructive"})}finally{F(!1)}},D=(s,t)=>{const a=s.target.files;if(!a)return;const i=Array.from(a),d=[];for(const x of i){if(x.size>10*1024*1024){m({title:"File too large",description:`${x.name} exceeds 10MB limit`,variant:"destructive"});continue}if(t==="image"){if(!x.type.startsWith("image/")){m({title:"Invalid file type",description:`${x.name} is not an image`,variant:"destructive"});continue}}else if(!["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(x.type)){m({title:"Invalid file type",description:`${x.name} is not a supported document type`,variant:"destructive"});continue}d.push(x)}k(x=>[...x,...d]),s.target&&(s.target.value="")},ne=s=>{k(t=>t.filter((a,i)=>i!==s))},le=async()=>{n&&await l.updateActiveStatus(n,"typing")},z=async()=>{n&&await l.updateActiveStatus(n,"online")};r.useEffect(()=>{let s;return f.trim()?(le(),s&&clearTimeout(s),s=setTimeout(()=>{z()},2e3)):z(),()=>{s&&clearTimeout(s)}},[f]),r.useEffect(()=>()=>{n&&l.updateActiveStatus(n,"offline")},[n]);const oe=async s=>{if(window.confirm("Are you sure you want to delete this conversation?"))try{await l.deleteConversation(s),S(t=>t.filter(a=>(a.id||a._id)!==s)),n===s&&(w(null),v([])),m({title:"Success",description:"Conversation deleted successfully!"})}catch(t){console.error("Failed to delete conversation:",t),m({title:"Error",description:"Failed to delete conversation. Please try again.",variant:"destructive"})}},ce=async s=>{if(window.confirm("Are you sure you want to delete this message? This action cannot be undone."))try{await l.deleteMessage(s),v(t=>t.filter(a=>a._id!==s)),m({title:"Success",description:"Message deleted successfully!"})}catch(t){console.error("Failed to delete message:",t),m({title:"Error",description:"Failed to delete message. Please try again.",variant:"destructive"})}},M=s=>s.otherUser,de=s=>{switch(s){case"sent":return e.jsx(Se,{className:"w-3 h-3 text-gray-400"});case"delivered":return e.jsx(K,{className:"w-3 h-3 text-gray-400"});case"read":return e.jsx(K,{className:"w-3 h-3 text-blue-500"});default:return null}},p=g.find(s=>(s.id||s._id)===n),c=p?M(p):null;if(Z)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading messages..."})]})});const me=g.filter(s=>{if(!h)return!0;const t=M(s);return t?(t.name||"Unknown User").toLowerCase().includes(h.toLowerCase())||s.lastMessage?.message.toLowerCase().includes(h.toLowerCase())||s.property?.title.toLowerCase().includes(h.toLowerCase()):!1});return e.jsxs("div",{className:"h-[calc(100vh-4rem)] flex flex-col md:flex-row gap-0 relative top-[60px]",children:[e.jsxs("div",{className:"w-full md:w-1/3 border-r border-border flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3 text-foreground",children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(pe,{placeholder:"Search conversations...",value:h,onChange:s=>X(s.target.value),className:"pl-10 h-9"})]})]}),e.jsx(G,{className:"flex-1",children:e.jsx("div",{className:"p-2",children:me.map(s=>{const t=M(s),a=t?.name||"Unknown User",i=s.id||s._id||"";return e.jsx("div",{className:`p-3 rounded-lg cursor-pointer transition-all duration-200 hover:bg-accent/50 ${n===i?"bg-accent border-l-4 border-primary":""}`,onClick:()=>w(i),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs($,{className:"h-12 w-12 border-2 border-background shadow-sm",children:[e.jsx(O,{src:void 0}),e.jsx(R,{className:"bg-primary/10 text-primary font-semibold",children:a.charAt(0).toUpperCase()})]}),o[t._id]?.isOnline?e.jsx("div",{title:"Online",className:"absolute -bottom-0.5 -right-0.5",children:e.jsx(N,{className:"w-3.5 h-3.5 fill-green-500 text-green-500 border-2 border-background rounded-full"})}):e.jsx("div",{title:`Last seen ${o[t._id]?.lastSeen?l.formatTime(o[t._id].lastSeen):"recently"}`,className:"absolute -bottom-0.5 -right-0.5",children:e.jsx(N,{className:"w-3.5 h-3.5 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("h4",{className:"text-sm font-semibold truncate",children:a}),o[t._id]?.isOnline&&e.jsx("span",{className:"text-[10px] text-green-600 font-medium whitespace-nowrap",children:"â— Online"})]}),e.jsxs("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.lastMessage?.createdAt||"").toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),s.unreadCount>0&&e.jsx(fe,{className:"bg-primary text-primary-foreground text-xs h-5 min-w-[20px] flex items-center justify-center px-1.5",children:s.unreadCount})]})]}),o[t._id]&&!o[t._id]?.isOnline&&e.jsxs("p",{className:"text-[10px] text-muted-foreground mb-1.5",children:["Last seen ",o[t._id]?.lastSeen?l.formatTime(o[t._id].lastSeen):"recently"]}),s.property&&e.jsxs("p",{className:"text-xs text-muted-foreground mb-1.5 truncate font-medium",children:["ðŸ“ ",s.property?.title||"General inquiry"]}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate line-clamp-1",children:[s.lastMessage?.isFromMe&&e.jsx("span",{className:"text-primary font-medium mr-1",children:"You:"}),s.lastMessage?.message]})]})]})},i)})})})]}),e.jsx("div",{className:"flex-1 flex flex-col bg-background",children:p?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsxs($,{className:"h-12 w-12 border-2 border-background shadow-sm",children:[e.jsx(O,{src:void 0}),e.jsx(R,{className:"bg-primary/10 text-primary font-semibold",children:c?.name?.charAt(0).toUpperCase()||"U"})]}),o[c?._id]?.isOnline?e.jsx(N,{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 fill-green-500 text-green-500 border-2 border-background rounded-full"}):e.jsx(N,{className:"absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 fill-gray-400 text-gray-400 border-2 border-background rounded-full"})]}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"font-semibold text-base truncate",children:c?.name||"Unknown User"}),o[c?._id]&&e.jsx("p",{className:"text-xs text-muted-foreground",children:o[c._id]?.isOnline?e.jsx("span",{className:"text-green-600 font-medium",children:"â— Active now"}):e.jsxs("span",{children:["Last seen ",o[c._id]?.lastSeen?l.formatTime(o[c._id].lastSeen):"recently"]})})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[c?.phone?Y?e.jsx(u,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0",title:"Call",onClick:()=>window.location.href=`tel:${c.phone}`,children:e.jsx(_,{className:"w-4 h-4"})}):e.jsxs(ge,{children:[e.jsx(be,{asChild:!0,children:e.jsx(u,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0",title:"View phone number",children:e.jsx(_,{className:"w-4 h-4"})})}),e.jsx(je,{className:"w-auto p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Phone Number"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-lg font-semibold",children:c.phone}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>{navigator.clipboard.writeText(c.phone||""),m({title:"Copied!",description:"Phone number copied to clipboard"})},children:"Copy"})]})]})})]}):e.jsx(u,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0",title:"No phone number available",disabled:!0,children:e.jsx(_,{className:"w-4 h-4 opacity-50"})}),e.jsxs(B,{children:[e.jsx(V,{asChild:!0,children:e.jsx(u,{size:"sm",variant:"ghost",className:"h-9 w-9 p-0",children:e.jsx(H,{className:"w-4 h-4"})})}),e.jsxs(q,{align:"end",children:[e.jsxs(y,{children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"Mark as Important"]}),e.jsxs(y,{children:[e.jsx(Ce,{className:"w-4 h-4 mr-2"}),"Archive"]}),e.jsxs(y,{className:"text-destructive focus:text-destructive",onClick:()=>oe(p.id||p._id||""),children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Delete Conversation"]})]})]})]})]}),p.property&&e.jsx("div",{className:"mt-3 p-3 bg-accent/50 rounded-lg border border-border",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1 h-8 bg-primary rounded-full"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-semibold truncate",children:p.property.title}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["â‚¹",p.property.price.toLocaleString()]})]})]})})]}),e.jsx(G,{className:"flex-1 p-4 bg-muted/20",children:se?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading messages..."})]})}):e.jsxs("div",{className:"space-y-4",children:[ee.map(s=>{const t=typeof s.sender=="string"?s.sender:s.sender._id,a=W?.id===t;return e.jsx("div",{className:`group flex ${a?"justify-end":"justify-start"} mb-4`,children:e.jsxs("div",{className:`max-w-[75%] md:max-w-[60%] rounded-2xl px-4 py-2.5 shadow-sm ${a?"bg-primary text-primary-foreground rounded-br-sm":"bg-background border border-border rounded-bl-sm"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words leading-relaxed",children:s.message}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2.5 space-y-2",children:s.attachments.map((i,d)=>e.jsx("div",{children:i.type==="image"?e.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx("img",{src:i.url,alt:i.name,className:"max-w-full rounded-lg border border-border cursor-pointer hover:opacity-90 transition-opacity",style:{maxHeight:"250px"}})}):e.jsxs("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 p-2.5 rounded-lg border transition-colors ${a?"border-primary-foreground/20 hover:bg-primary-foreground/10":"border-border bg-muted/50 hover:bg-muted"}`,children:[e.jsx(Q,{className:"w-4 h-4 flex-shrink-0"}),e.jsx("span",{className:"text-sm truncate",children:i.name})]})},d))}),e.jsxs("div",{className:`flex items-center justify-between mt-1.5 gap-2 ${a?"text-primary-foreground/70":"text-muted-foreground"}`,children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-[11px]",children:new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[a&&de(s.status),a&&e.jsxs(B,{children:[e.jsx(V,{asChild:!0,children:e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-destructive/10",title:"Message options",children:e.jsx(H,{className:"w-3.5 h-3.5"})})}),e.jsx(q,{align:"end",children:e.jsxs(y,{className:"text-destructive focus:text-destructive",onClick:()=>ce(s._id),children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Delete Message"]})})]})]})]})]})},s._id)}),te&&e.jsx("div",{className:"flex justify-start mb-4",children:e.jsx("div",{className:"bg-background border border-border px-4 py-3 rounded-2xl rounded-bl-sm shadow-sm",children:e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[c?.name," is typing..."]})]})})}),e.jsx("div",{ref:re})]})}),e.jsxs("div",{className:"p-4 border-t border-border bg-background",children:[b.length>0&&e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:b.map((s,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-accent px-3 py-2 rounded-lg border border-border",children:[e.jsx("span",{className:"text-sm truncate max-w-[200px]",children:s.name}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-5 w-5 p-0 hover:bg-destructive/10",onClick:()=>ne(t),children:"Ã—"})]},t))}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx("input",{ref:I,type:"file",className:"hidden",accept:".pdf,.doc,.docx",onChange:s=>D(s,"document"),multiple:!0}),e.jsx("input",{ref:L,type:"file",className:"hidden",accept:"image/*",onChange:s=>D(s,"image"),multiple:!0}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-10 w-10 p-0",onClick:()=>I.current?.click(),disabled:j,title:"Attach document",children:e.jsx(Q,{className:"w-5 h-5"})}),e.jsx(u,{size:"sm",variant:"ghost",className:"h-10 w-10 p-0",onClick:()=>L.current?.click(),disabled:j,title:"Attach image",children:e.jsx(Me,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex-1",children:e.jsx(Ne,{placeholder:"Type your message...",value:f,onChange:s=>A(s.target.value),className:"min-h-[56px] max-h-[120px] resize-none rounded-xl",onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),E())},disabled:j})}),e.jsx(u,{onClick:E,disabled:!f.trim()&&b.length===0||j,className:"h-10 w-10 p-0 rounded-full",title:"Send message",children:j?e.jsx(ye,{className:"w-5 h-5 animate-spin"}):e.jsx(_e,{className:"w-5 h-5"})})]})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center bg-muted/20",children:e.jsxs("div",{className:"text-center px-4",children:[e.jsx("div",{className:"mb-4 inline-flex p-4 bg-primary/10 rounded-full",children:e.jsx(we,{className:"w-12 h-12 text-primary"})}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground max-w-sm",children:"Choose a conversation from the list to start messaging with your clients"})]})})})]})};export{Ge as default};
