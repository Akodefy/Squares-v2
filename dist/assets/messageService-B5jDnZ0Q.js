import{t as i}from"./index-DGiQKbnC.js";const g="https://api.akodefy.com/api";class p{async makeRequest(e,t={}){const s=`${g}${e}`,a={headers:{"Content-Type":"application/json",...t.headers},...t},r=localStorage.getItem("token");r&&(a.headers={...a.headers,Authorization:`Bearer ${r}`});try{const o=await fetch(s,a);if(!o.ok){const n=await o.json().catch(()=>({success:!1,message:`HTTP ${o.status}: ${o.statusText}`}));throw new Error(n.message||"An error occurred")}return await o.json()}catch(o){throw console.error("Message API request failed:",o),o}}async getConversations(e={}){try{const t=new URLSearchParams;e.page&&t.append("page",e.page.toString()),e.limit&&t.append("limit",e.limit.toString()),e.search&&t.append("search",e.search),e.status&&e.status!=="all"&&t.append("status",e.status),e.type&&e.type!=="all"&&t.append("type",e.type);const s=`/messages/conversations${t.toString()?`?${t.toString()}`:""}`,a=await this.makeRequest(s);if(a.success&&a.data)return a.data;throw new Error("Failed to fetch conversations")}catch(t){const s=t instanceof Error?t.message:"Failed to fetch conversations";throw i({title:"Error",description:s,variant:"destructive"}),t}}async getConversationMessages(e,t=1,s=50,a=!0){try{const r=new URLSearchParams;r.append("page",t.toString()),r.append("limit",s.toString()),r.append("markAsRead",a.toString());const o=`/messages/conversation/${e}?${r.toString()}`,n=await this.makeRequest(o);if(n.success&&n.data)return n.data;throw new Error("Failed to fetch conversation messages")}catch(r){const o=r instanceof Error?r.message:"Failed to fetch conversation messages";throw i({title:"Error",description:o,variant:"destructive"}),r}}async sendMessage(e,t,s,a){try{let r=s;if(!r){const n=e.split("_"),c=localStorage.getItem("userId");if(r=n.find(u=>u!==c),!r)throw new Error("Unable to determine recipient")}const o=await this.makeRequest("/messages",{method:"POST",body:JSON.stringify({conversationId:e,recipientId:r,content:t,attachments:a||[]})});if(o.success&&o.data)return i({title:"Success",description:"Message sent successfully!"}),o.data.message;throw new Error("Failed to send message")}catch(r){const o=r instanceof Error?r.message:"Failed to send message";throw i({title:"Error",description:o,variant:"destructive"}),r}}async uploadAttachment(e){const t="https://api.akodefy.com";try{if(e.size>10485760)throw new Error("File size must be less than 10MB");const a=["image/jpeg","image/jpg","image/png","image/gif"],r=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"],o=a.includes(e.type),n=r.includes(e.type);if(!o&&!n)throw new Error("File type not supported. Please upload images (jpg, png, gif) or documents (pdf, doc, docx)");const c=new FormData;c.append("file",e),c.append("folder","messages");const u=localStorage.getItem("token"),l=await fetch(`${t}/upload/single`,{method:"POST",headers:{Authorization:`Bearer ${u}`},body:c}),d=await l.json();if(!l.ok||!d.success)throw new Error(d.message||"Failed to upload file");return{type:o?"image":"document",url:d.data.url,name:e.name,size:e.size}}catch(s){const a=s instanceof Error?s.message:"Failed to upload file";throw i({title:"Upload Error",description:a,variant:"destructive"}),s}}static async sendPropertyInquiry(e,t,s){try{const a=localStorage.getItem("token");if(!a)throw i({title:"Error",description:"Please login to send messages",variant:"destructive"}),new Error("Not authenticated");const r=await fetch(`${g}/messages/property-inquiry`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({propertyId:e,subject:t,content:s})}),o=await r.json();if(!r.ok)throw new Error(o.message||"Failed to send message");return i({title:"Success",description:"Message sent successfully"}),o.data}catch(a){throw console.error("Error sending property inquiry:",a),i({title:"Error",description:a.message||"Failed to send message",variant:"destructive"}),a}}async markMessageAsRead(e){try{if(!(await this.makeRequest(`/messages/${e}/read`,{method:"PATCH"})).success)throw new Error("Failed to mark message as read")}catch(t){console.error("Failed to mark message as read:",t)}}async markConversationAsRead(e){try{if(!(await this.makeRequest(`/messages/conversation/${e}/read`,{method:"PATCH"})).success)throw new Error("Failed to mark conversation as read")}catch(t){console.error("Failed to mark conversation as read:",t)}}async markSingleMessageAsRead(e){try{const t=await this.makeRequest(`/messages/${e}/read`,{method:"PATCH"});if(!t.success)throw new Error("Failed to mark message as read");return t.data}catch(t){console.error("Failed to mark message as read:",t)}}async updateTypingStatus(e,t){try{if(!e){console.warn("Cannot update typing status: conversationId is missing");return}await this.makeRequest("/messages/typing-status",{method:"POST",body:JSON.stringify({conversationId:e,isTyping:t})})}catch(s){console.error("Failed to update typing status:",s)}}async getTypingStatus(e){try{return(await this.makeRequest(`/messages/typing-status/${e}`)).data.isTyping}catch(t){return console.error("Failed to get typing status:",t),!1}}async updateOnlineStatus(e){try{await this.makeRequest("/messages/online-status",{method:"POST",body:JSON.stringify({status:e})})}catch(t){console.error("Failed to update online status:",t)}}async getUserOnlineStatus(e){try{const t=await this.makeRequest(`/messages/online-status/${e}`);return{isOnline:t.data.isOnline||!1,lastSeen:t.data.lastSeen?new Date(t.data.lastSeen):null}}catch(t){return console.error("Failed to get online status:",t),{isOnline:!1,lastSeen:null}}}async getNotificationPreferences(){try{return(await this.makeRequest("/messages/notification-preferences")).data.notifications}catch(e){return console.error("Failed to get notification preferences:",e),{email:!0,sms:!1,push:!0,desktop:!0,sound:!0,typing:!0}}}async updateNotificationPreferences(e){try{await this.makeRequest("/messages/notification-preferences",{method:"PUT",body:JSON.stringify(e)})}catch(t){console.error("Failed to update notification preferences:",t)}}async getUnreadCount(){try{return(await this.makeRequest("/messages/unread-count")).data.unreadCount}catch(e){return console.error("Failed to get unread count:",e),0}}async updateActiveStatus(e,t){try{if(!e){console.warn("Cannot update active status: conversationId is missing");return}const s=await this.makeRequest("/messages/active-status",{method:"POST",body:JSON.stringify({conversationId:e,status:t})});s.success||console.error("Failed to update active status:",s.message)}catch(s){s instanceof Error&&s.message.includes("admin")?console.warn("Active status not available for admin conversations"):console.error("Failed to update active status:",s)}}async getActiveStatus(e){try{const t=await this.makeRequest(`/messages/active-status/${e}`);return t.success?t.data.statuses:{}}catch(t){return console.error("Failed to get active status:",t),{}}}async deleteMessage(e){try{if((await this.makeRequest(`/messages/${e}`,{method:"DELETE"})).success)i({title:"Success",description:"Message deleted successfully!"});else throw new Error("Failed to delete message")}catch(t){const s=t instanceof Error?t.message:"Failed to delete message";throw i({title:"Error",description:s,variant:"destructive"}),t}}async deleteConversation(e){try{if((await this.makeRequest(`/messages/conversations/${e}`,{method:"DELETE"})).success)i({title:"Success",description:"Conversation deleted successfully!"});else throw new Error("Failed to delete conversation")}catch(t){const s=t instanceof Error?t.message:"Failed to delete conversation";throw i({title:"Error",description:s,variant:"destructive"}),t}}formatName(e){return`${e.profile.firstName} ${e.profile.lastName}`}async markAsRead(e,t){try{await this.markConversationAsRead(e)}catch(s){console.error("Failed to mark as read:",s)}}async getUserStatus(e){try{const t=await this.getUserOnlineStatus(e);return{userId:e,isOnline:t.isOnline,lastSeen:t.lastSeen?t.lastSeen.toISOString():new Date().toISOString(),isTyping:!1}}catch(t){return console.error("Failed to get user status:",t),{userId:e,isOnline:!1,lastSeen:new Date().toISOString(),isTyping:!1}}}async setTypingStatus(e,t){try{await this.updateTypingStatus(e,t)}catch(s){console.error("Failed to set typing status:",s)}}async updateUserActivity(e="online"){try{const t=e==="online"?"online":"offline";await this.updateOnlineStatus(t)}catch(t){console.error("Failed to update user activity:",t)}}formatTime(e){if(!e)return"recently";try{const t=new Date(e);if(isNaN(t.getTime()))return"recently";const s=new Date,a=s.getTime()-t.getTime();if(a<0)return"Just now";const r=Math.floor(a/(1e3*60));if(r<1)return"Just now";if(r<60)return`${r} min ago`;const o=Math.floor(r/60);if(o<24)return`${o} hr ago`;const n=Math.floor(o/24);return n<7?`${n} day${n>1?"s":""} ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:t.getFullYear()!==s.getFullYear()?"numeric":void 0})}catch(t){return console.error("Error formatting time:",t,e),"recently"}}formatPrice(e,t){return t==="rent"?`â‚¹${e.toLocaleString("en-IN")}/month`:e>=1e7?`â‚¹${(e/1e7).toFixed(1)} Cr`:e>=1e5?`â‚¹${(e/1e5).toFixed(1)} L`:`â‚¹${e.toLocaleString("en-IN")}`}getPriorityColor(e){switch(e){case"high":case"urgent":return"bg-red-500";case"medium":return"bg-yellow-500";case"low":return"bg-green-500";default:return"bg-gray-500"}}getStatusColor(e){switch(e){case"unread":return"bg-red-500";case"read":return"bg-yellow-500";case"responded":return"bg-green-500";default:return"bg-gray-500"}}async sendAutoResponse(e,t,s){try{const a=`ðŸ¤– ${s}`,r=await this.makeRequest("/messages",{method:"POST",body:JSON.stringify({conversationId:e,recipientId:t,content:a,type:"auto_response",attachments:[]})});if(r.success&&r.data)return console.log("Auto-response sent successfully:",r.data.message._id),r.data.message;throw new Error("Failed to send auto-response")}catch(a){return console.error("Failed to send auto-response:",a),null}}isAutoResponse(e){return e.type==="auto_response"||(e.message||e.content)&&((e.message||e.content).startsWith("ðŸ¤–")||(e.message||e.content).toLowerCase().includes("auto-response")||(e.message||e.content).toLowerCase().includes("automatic response")||(e.message||e.content).toLowerCase().includes("i'll get back to you"))}getAutoResponseIndicator(){return"ðŸ¤–"}}const y=new p;export{p as M,y as m};
