import{t as c}from"./index-DGiQKbnC.js";import"./ui-CMGlPv8M.js";import"./router-02yfTqxa.js";import"./vendor-Dazix4UH.js";const y="https://api.akodefy.com/api";class l{async makeRequest(r,e={}){const a=`${y}${r}`,t={headers:{"Content-Type":"application/json",...e.headers},...e},s=localStorage.getItem("token");s&&(t.headers={...t.headers,Authorization:`Bearer ${s}`});try{const o=await fetch(a,t);if(console.log("Payment API request:",{url:a,method:t.method||"GET"}),console.log("Payment API response status:",o.status),!o.ok){const d=await o.json().catch(()=>({success:!1,message:`HTTP ${o.status}: ${o.statusText}`}));throw console.log("Payment API error data:",d),new Error(d.message||"An error occurred")}return await o.json()}catch(o){throw console.error("Payment API request failed:",o),o}}loadRazorpayScript(){return new Promise((r,e)=>{if(window.Razorpay){r();return}const a=document.createElement("script");a.src="https://checkout.razorpay.com/v1/checkout.js",a.onload=()=>r(),a.onerror=()=>e(new Error("Failed to load Razorpay script")),document.head.appendChild(a)})}async createPaymentOrder(r,e="monthly"){try{const a=await this.makeRequest("/payments/create-order",{method:"POST",body:JSON.stringify({planId:r,billingCycle:e})});if(!a.success)throw new Error("Failed to create payment order");return a.data}catch(a){const t=a instanceof Error?a.message:"Failed to create payment order";throw c({title:"Payment Error",description:t,variant:"destructive"}),a}}async verifyPayment(r){try{const e=await this.makeRequest("/payments/verify-payment",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error(e.message||"Payment verification failed");return e.data}catch(e){const a=e instanceof Error?e.message:"Payment verification failed";throw c({title:"Payment Verification Failed",description:a,variant:"destructive"}),e}}async initiatePayment(r){try{await this.loadRazorpayScript();const e=await this.createPaymentOrder(r.planId,r.billingCycle),a={key:e.keyId,amount:e.amount,currency:e.currency,name:"BuildHomeMartSquares",description:`Subscription to ${e.planName}`,order_id:e.orderId,prefill:{email:e.userEmail},theme:{color:"#2563eb"},handler:async s=>{try{const o=await this.verifyPayment({razorpay_order_id:s.razorpay_order_id,razorpay_payment_id:s.razorpay_payment_id,razorpay_signature:s.razorpay_signature,planId:r.planId,billingCycle:r.billingCycle||"monthly"});c({title:"Payment Successful!",description:"Your subscription has been activated successfully."}),r.onSuccess&&r.onSuccess(o)}catch(o){console.error("Payment verification failed:",o),r.onFailure&&r.onFailure(o)}},modal:{ondismiss:()=>{c({title:"Payment Cancelled",description:"Payment was cancelled by user.",variant:"destructive"}),r.onFailure&&r.onFailure(new Error("Payment cancelled"))}}};new window.Razorpay(a).open()}catch(e){console.error("Payment initiation failed:",e);const a=e instanceof Error?e.message:"Failed to initiate payment";c({title:"Payment Failed",description:a,variant:"destructive"}),r.onFailure&&r.onFailure(e)}}async processSubscriptionPayment(r){try{await this.loadRazorpayScript();const e=await this.makeRequest("/payments/create-subscription-order",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error("Failed to create payment order");const a=e.data;return new Promise((t,s)=>{const o={key:a.keyId,amount:a.amount,currency:a.currency,name:"BuildHomeMartSquares",description:`Subscription to ${a.planName}${r.addons.length>0?` with ${r.addons.length} addon(s)`:""}`,order_id:a.orderId,prefill:{email:a.userEmail},theme:{color:"#2563eb"},handler:async i=>{try{const n=await this.verifySubscriptionPayment({razorpay_order_id:i.razorpay_order_id,razorpay_payment_id:i.razorpay_payment_id,razorpay_signature:i.razorpay_signature,planId:r.planId,addons:r.addons,billingCycle:r.billingCycle,totalAmount:r.totalAmount});t({success:!0,data:n})}catch(n){console.error("Payment verification failed:",n),s({success:!1,message:n instanceof Error?n.message:"Payment verification failed"})}},modal:{ondismiss:()=>{s({success:!1,message:"Payment was cancelled by user"})}}};new window.Razorpay(o).open()})}catch(e){return console.error("Subscription payment failed:",e),{success:!1,message:e instanceof Error?e.message:"Failed to process subscription payment"}}}async verifySubscriptionPayment(r){try{const e=await this.makeRequest("/payments/verify-subscription-payment",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error(e.message||"Subscription payment verification failed");return e.data}catch(e){const a=e instanceof Error?e.message:"Subscription payment verification failed";throw new Error(a)}}async processAddonPayment(r){try{const e=await this.makeRequest("/payments/create-addon-order",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error("Failed to create addon payment order");const a=e.data;if(console.log("Addon payment order created:",a),a.isMockPayment||a.keyId==="mock_key_for_development"){console.log("Processing mock addon payment for development");try{const t=await this.verifyAddonPayment({razorpay_order_id:a.orderId,razorpay_payment_id:`mock_payment_${Date.now()}`,razorpay_signature:"mock_signature",addons:r.addons,totalAmount:r.totalAmount});return console.log("Mock addon payment verification result:",t),c({title:"Payment Successful!",description:"Addons have been added to your subscription successfully."}),{success:!0,data:t}}catch(t){return console.error("Mock addon payment verification failed:",t),{success:!1,message:t instanceof Error?t.message:"Mock addon payment verification failed"}}}return await this.loadRazorpayScript(),new Promise((t,s)=>{const o={key:a.keyId,amount:a.amount,currency:a.currency,name:"BuildHomeMartSquares",description:`Addon purchase - ${r.addons.length} addon(s)`,order_id:a.orderId,prefill:{email:a.userEmail},theme:{color:"#2563eb"},handler:async i=>{try{console.log("Verifying addon payment with data:",{orderId:i.razorpay_order_id,paymentId:i.razorpay_payment_id,signature:i.razorpay_signature,addons:r.addons,totalAmount:r.totalAmount});const n=await this.verifyAddonPayment({razorpay_order_id:i.razorpay_order_id,razorpay_payment_id:i.razorpay_payment_id,razorpay_signature:i.razorpay_signature,addons:r.addons,totalAmount:r.totalAmount});console.log("Addon payment verification result:",n),c({title:"Payment Successful!",description:"Addons have been added to your subscription successfully."}),t({success:!0,data:n})}catch(n){console.error("Addon payment verification failed:",n),s({success:!1,message:n instanceof Error?n.message:"Addon payment verification failed"})}},modal:{ondismiss:()=>{s({success:!1,message:"Payment was cancelled by user"})}}};new window.Razorpay(o).open()})}catch(e){return console.error("Addon payment failed:",e),{success:!1,message:e instanceof Error?e.message:"Failed to process addon payment"}}}async verifyAddonPayment(r){try{const e=await this.makeRequest("/payments/verify-addon-payment",{method:"POST",body:JSON.stringify(r)});if(!e.success)throw new Error(e.message||"Addon payment verification failed");return e.data}catch(e){const a=e instanceof Error?e.message:"Addon payment verification failed";throw new Error(a)}}async getPaymentStatus(r){try{return(await this.makeRequest(`/payments/status/${r}`)).data}catch(e){throw console.error("Failed to fetch payment status:",e),e}}async markPaymentAsFailed(r,e,a){try{return(await this.makeRequest("/payments/mark-failed",{method:"POST",body:JSON.stringify({orderId:r,paymentId:e,reason:a})})).data}catch(t){throw console.error("Failed to mark payment as failed:",t),t}}async checkPaymentStatus(r){try{const e=await this.getPaymentStatus(r);return e.status==="pending"&&e.isExpired?{status:"cancelled",isExpired:!0,message:"Payment timeout - exceeded Razorpay limit"}:{status:e.status,isExpired:e.isExpired||!1,message:e.failureReason}}catch(e){throw console.error("Failed to check payment status:",e),e}}}const g=new l;export{g as default,g as paymentService};
