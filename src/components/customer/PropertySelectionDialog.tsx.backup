import { useState, useEffect } from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { MapPin, Bed, Bath, Maximize, Search, Loader2, Check } from "lucide-react";
import { toast } from "@/hooks/use-toast";
import favoriteService, { Favorite } from "@/services/favoriteService";
import propertyService, { Property } from "@/services/propertyService";

interface PropertySelectionDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onPropertySelect: (propertyId: string) => Promise<void>;
  selectedPropertyIds: string[];
  maxSelections?: number;
}

const PropertySelectionDialog = ({
  open,
  onOpenChange,
  onPropertySelect,
  selectedPropertyIds,
  maxSelections = 10
}: PropertySelectionDialogProps) => {
  const [favorites, setFavorites] = useState<Favorite[]>([]);
  const [allProperties, setAllProperties] = useState<Property[]>([]);
  const [loading, setLoading] = useState(false);
  const [addingPropertyId, setAddingPropertyId] = useState<string | null>(null);
  const [searchQuery, setSearchQuery] = useState("");
  const [activeTab, setActiveTab] = useState("favorites");

  const loadFavorites = async () => {
    setLoading(true);
    try {
      const response = await favoriteService.getFavorites({ limit: 100 });
      if (response.success) {
        setFavorites(response.data.favorites);
      }
    } catch (error) {
      console.error("Error loading favorites:", error);
    } finally {
      setLoading(false);
    }
  };

  const loadAllProperties = async () => {
    try {
      const response = await propertyService.getProperties({ limit: 100 });
      if (response.success) {
        setAllProperties(response.data.properties);
      }
    } catch (error) {
      console.error("Error loading properties:", error);
    }
  };

  useEffect(() => {
    loadFavorites();
    loadAllProperties();
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  const handlePropertyClick = async (propertyId: string) => {
    if (addingPropertyId) return;
    
    if (selectedPropertyIds.includes(propertyId)) {
      toast({
        title: "Already Selected",
        description: "This property is already in your comparison",
        variant: "destructive"
      });
      return;
    }

    if (selectedPropertyIds.length >= maxSelections) {
      toast({
        title: "Maximum Selections Reached",
        description: `You can only compare up to ${maxSelections} properties`,
        variant: "destructive"
      });
      return;
    }

    try {
      setAddingPropertyId(propertyId);
      await onPropertySelect(propertyId);
      onOpenChange(false);
    } catch (error) {
      console.error("Error selecting property:", error);
    } finally {
      setAddingPropertyId(null);
    }
  };

  const formatPrice = (price: number, listingType: string) => {
    if (listingType === 'rent') return `₹${price.toLocaleString("en-IN")}/month`;
    if (listingType === 'lease') return `₹${price.toLocaleString("en-IN")}/year`;
    if (price >= 10000000) return `₹${(price / 10000000).toFixed(1)} Cr`;
    if (price >= 100000) return `₹${(price / 100000).toFixed(1)} Lac`;
    return `₹${price.toLocaleString("en-IN")}`;
  };

  const formatArea = (area: any) => {
    if (area.builtUp) return `${area.builtUp} ${area.unit}`;
    if (area.plot) return `${area.plot} ${area.unit}`;
    if (area.carpet) return `${area.carpet} ${area.unit}`;
    return "N/A";
  };

  const getPrimaryImage = (images: any[]) => {
    const primary = images.find(img => img.isPrimary);
    return primary?.url || images[0]?.url || "/placeholder-property.jpg";
  };

  const filterProperties = (properties: any[]) => {
    if (!searchQuery) return properties;
    const query = searchQuery.toLowerCase();
    return properties.filter(item => {
      const property = item.property || item;
      return (
        property.title?.toLowerCase().includes(query) ||
        property.address?.city?.toLowerCase().includes(query) ||
        property.address?.state?.toLowerCase().includes(query)
      );
    });
  };

  const availableFavorites = filterProperties(
    favorites.filter(fav => fav.property && !selectedPropertyIds.includes(fav.property._id))
  );

  const availableProperties = filterProperties(
    allProperties.filter(prop => !selectedPropertyIds.includes(prop._id))
  );

  const PropertyCard = ({ property }: { property: any }) => {
    const isSelected = selectedPropertyIds.includes(property._id);
    const isAdding = addingPropertyId === property._id;

    return (
      <Card 
        className={`cursor-pointer transition-all hover:shadow-md ${
          isSelected ? 'border-primary bg-primary/5' : ''
        } ${isAdding ? 'opacity-50' : ''}`}
        onClick={() => !isAdding && handlePropertyClick(property._id)}
      >
        <CardContent className="p-4">
          <div className="flex gap-4">
            <div className="w-20 h-20 bg-muted rounded-lg overflow-hidden flex-shrink-0">
              <img
                src={getPrimaryImage(property.images)}
                alt={property.title}
                className="w-full h-full object-cover"
                onError={(e) => {
                  e.currentTarget.src = "/placeholder-property.jpg";
                }}
              />
            </div>
            
            <div className="flex-1 min-w-0">
              <h3 className="font-medium text-sm mb-1 line-clamp-2">{property.title}</h3>
              
              <div className="flex items-center text-xs text-muted-foreground mb-2">
                <MapPin className="w-3 h-3 mr-1 flex-shrink-0" />
                <span className="truncate">
                  {property.address.city}, {property.address.state}
                </span>
              </div>

              <div className="text-primary font-semibold text-sm mb-2">
                {formatPrice(property.price, property.listingType)}
              </div>

              <div className="flex items-center gap-3 text-xs text-muted-foreground mb-3">
                <div className="flex items-center gap-1">
                  <Bed className="w-3 h-3" />
                  <span>{property.bedrooms}</span>
                </div>
                <div className="flex items-center gap-1">
                  <Bath className="w-3 h-3" />
                  <span>{property.bathrooms}</span>
                </div>
                <div className="flex items-center gap-1">
                  <Maximize className="w-3 h-3" />
                  <span>{formatArea(property.area)}</span>
                </div>
              </div>

              <div className="flex gap-2">
                <Badge variant="outline" className="text-xs">
                  {property.type}
                </Badge>
                <Badge variant="outline" className="text-xs capitalize">
                  {property.listingType}
                </Badge>
                {isSelected && (
                  <Badge variant="default" className="text-xs">
                    <Check className="w-3 h-3 mr-1" />
                    Selected
                  </Badge>
                )}
                {isAdding && (
                  <Badge variant="secondary" className="text-xs">
                    <Loader2 className="w-3 h-3 mr-1 animate-spin" />
                    Adding...
                  </Badge>
                )}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    );
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle>Select Property to Compare</DialogTitle>
          <DialogDescription>
            Click on a property to add it to your comparison. You can select up to {maxSelections} properties.
            ({selectedPropertyIds.length}/{maxSelections} selected)
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4" />
            <Input
              placeholder="Search properties by title, city, or state..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>

          <Tabs value={activeTab} onValueChange={setActiveTab}>
            <TabsList className="grid w-full grid-cols-2">
              <TabsTrigger value="favorites">
                Favorites ({availableFavorites.length})
              </TabsTrigger>
              <TabsTrigger value="all">
                All Properties ({availableProperties.length})
              </TabsTrigger>
            </TabsList>

            <TabsContent value="favorites" className="mt-4">
              <ScrollArea className="h-[500px] pr-4">
                {loading ? (
                  <div className="flex items-center justify-center py-12">
                    <Loader2 className="w-8 h-8 animate-spin text-primary" />
                  </div>
                ) : availableFavorites.length === 0 ? (
                  <div className="text-center py-12 text-muted-foreground">
                    {searchQuery ? "No favorites match your search" : "No favorites available"}
                  </div>
                ) : (
                  <div className="space-y-3">
                    {availableFavorites.map((favorite) => (
                      <PropertyCard key={favorite._id} property={favorite.property} />
                    ))}
                  </div>
                )}
              </ScrollArea>
            </TabsContent>

            <TabsContent value="all" className="mt-4">
              <ScrollArea className="h-[500px] pr-4">
                {loading ? (
                  <div className="flex items-center justify-center py-12">
                    <Loader2 className="w-8 h-8 animate-spin text-primary" />
                  </div>
                ) : availableProperties.length === 0 ? (
                  <div className="text-center py-12 text-muted-foreground">
                    {searchQuery ? "No properties match your search" : "No properties available"}
                  </div>
                ) : (
                  <div className="space-y-3">
                    {availableProperties.map((property) => (
                      <PropertyCard key={property._id} property={property} />
                    ))}
                  </div>
                )}
              </ScrollArea>
            </TabsContent>
          </Tabs>
        </div>
      </DialogContent>
    </Dialog>
  );
};

export default PropertySelectionDialog;
